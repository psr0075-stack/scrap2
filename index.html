<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Creative Archive Fixed</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600&family=Playfair+Display:ital,wght@0,400;0,500;0,600;1,400;1,500&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <style>
        body { font-family: 'Inter', sans-serif; overflow: hidden; margin: 0; background-color: #f9fafb; color: #18181b; -webkit-tap-highlight-color: transparent; }
        .font-serif { font-family: 'Playfair Display', serif; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .noselect { -webkit-touch-callout: none; -webkit-user-select: none; user-select: none; }
        
        #intro-scene { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 100; background: #f9fafb; display: flex; align-items: center; justify-content: center; transition: opacity 0.5s ease; pointer-events: auto; }
        .poster-card { width: 90%; max-width: 400px; height: 600px; max-height: 80vh; border-radius: 16px; background: #ffffff; border: 1px solid rgba(0,0,0,0.06); box-shadow: 0 20px 60px -10px rgba(0,0,0,0.1); display: flex; flex-direction: column; justify-content: space-between; padding: 40px; text-align: center; }
        .enter-btn { padding: 14px 40px; background: #18181b; color: #fff; font-size: 12px; font-weight: 600; letter-spacing: 0.1em; text-transform: uppercase; border-radius: 99px; box-shadow: 0 4px 12px rgba(0,0,0,0.15); transition: transform 0.2s; }
        .enter-btn:active { transform: scale(0.95); }

        .mode-app-container { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 50; pointer-events: none; opacity: 0; transition: opacity 0.5s ease; background: #f9fafb; display: flex; flex-direction: column; }
        .mode-app-active { opacity: 1; pointer-events: auto; }
        
        .folder-tab { padding: 12px 24px; font-family: 'Playfair Display', serif; font-style: italic; font-size: 16px; transition: all 0.2s; cursor: pointer; }
        .folder-tab.active { font-weight: 700; color: #000; border-bottom: 2px solid #000; }
        .folder-tab.inactive { font-weight: 400; color: #9ca3af; }
        
        .detail-tab-btn { padding-bottom: 8px; font-size: 14px; font-weight: 600; color: #9ca3af; border-bottom: 2px solid transparent; transition: all 0.2s; }
        .detail-tab-btn.active { color: #000; border-bottom-color: #000; }
        
        .card-press-active { transform: scale(0.96); opacity: 0.9; transition: transform 0.1s; }
        
        /* Modal Z-Indexes */
        #add-modal, #menu-modal, #memo-modal, #insight-modal, #folder-modal, #detail-view-modal, #settings-modal { z-index: 300; }
    </style>
</head>
<body>
    <input type="file" id="hidden-thumb-input" accept="image/*" class="hidden" onchange="handleThumbUpdate(event)">
    <input type="file" id="import-file-input" accept=".json" class="hidden" onchange="importData(event)">

    <div id="intro-scene">
        <div class="poster-card">
            <div class="flex justify-between w-full pb-4 border-b border-gray-100"><span class="text-[10px] tracking-widest text-gray-400">ARCHIVE</span><span class="text-[10px] tracking-widest text-gray-400">V.6.1</span></div>
            <div class="flex flex-col items-center gap-4"><h1 class="font-serif italic text-5xl text-black">Creative<br>Archive</h1><p class="text-xs text-gray-400 tracking-widest">Curate your inspiration</p></div>
            <div class="flex justify-center"><button onclick="enterApp()" class="enter-btn">Enter</button></div>
        </div>
    </div>

    <div id="app-content" class="mode-app-container">
        <div class="h-16 px-5 flex items-center justify-between bg-white border-b border-gray-100 z-50">
            <div class="flex items-center gap-4">
                <button onclick="exitApp()" class="p-2 rounded-full hover:bg-gray-100"><i data-lucide="arrow-left" class="w-5 h-5"></i></button>
                <div class="flex gap-4">
                    <button onclick="switchTab('scraps')" id="tab-scraps" class="folder-tab active">Scraps</button>
                    <button onclick="switchTab('folders')" id="tab-folders" class="folder-tab inactive">Folders</button>
                    <button onclick="switchTab('favorites')" id="tab-favorites" class="folder-tab inactive">Favs</button>
                </div>
            </div>
            <div class="flex items-center gap-3">
                <button onclick="openSettingsModal()" class="w-10 h-10 rounded-full bg-gray-100 text-gray-600 flex items-center justify-center hover:bg-gray-200 transition" title="Settings"><i data-lucide="settings" class="w-5 h-5"></i></button>
                <button onclick="openAddModal()" class="w-10 h-10 rounded-full bg-black text-white flex items-center justify-center shadow-md hover:scale-105 transition" title="New Item"><i data-lucide="plus" class="w-5 h-5"></i></button>
            </div>
        </div>

        <div class="flex-grow relative bg-[#fafafa] overflow-hidden">
            <div class="absolute top-0 left-0 right-0 p-4 z-40 bg-[#fafafa]/90 backdrop-blur-sm">
                <div class="relative max-w-md mx-auto">
                    <i data-lucide="search" class="absolute left-3 top-2.5 w-4 h-4 text-gray-400"></i>
                    <input type="text" oninput="handleSearch(event)" placeholder="Search..." class="w-full pl-10 pr-4 py-2 bg-white border border-gray-200 rounded-full text-sm shadow-sm focus:outline-none focus:border-black">
                </div>
            </div>

            <div id="view-grid" class="absolute inset-0 pt-20 pb-10 px-4 overflow-y-auto no-scrollbar">
                <div id="scrap-grid" class="grid grid-cols-2 md:grid-cols-4 gap-4 max-w-6xl mx-auto"></div>
                <div id="empty-state" class="hidden flex flex-col items-center justify-center h-full text-gray-400 mt-20"><i data-lucide="inbox" class="w-10 h-10 mb-2 opacity-50"></i><span class="text-xs tracking-widest">NO ITEMS</span></div>
            </div>

            <div id="view-folders" class="absolute inset-0 pt-20 pb-10 px-4 overflow-y-auto no-scrollbar hidden">
                <button onclick="openFolderModal()" class="mb-6 mx-auto flex items-center gap-2 bg-white px-4 py-2 rounded-full border border-gray-200 text-sm font-bold shadow-sm"><i data-lucide="folder-plus" class="w-4 h-4"></i> New Folder</button>
                <div id="folder-list" class="grid grid-cols-2 md:grid-cols-4 gap-4 max-w-6xl mx-auto"></div>
            </div>
            
            <div id="view-folder-detail" class="absolute inset-0 bg-[#fafafa] z-30 flex flex-col hidden">
                <div class="px-6 py-4 flex items-center bg-white border-b border-gray-100">
                    <button onclick="closeFolderDetail()" class="mr-4"><i data-lucide="arrow-left" class="w-5 h-5"></i></button>
                    <h2 id="folder-detail-title" class="font-serif italic text-xl">Folder</h2>
                </div>
                <div id="folder-detail-grid" class="p-4 grid grid-cols-2 md:grid-cols-4 gap-4 overflow-y-auto no-scrollbar flex-grow"></div>
            </div>
        </div>
    </div>

    <div id="add-modal" class="fixed inset-0 hidden">
        <div class="absolute inset-0 bg-black/30 backdrop-blur-sm" onclick="closeAddModal()"></div>
        <div id="add-panel" class="absolute right-0 top-0 bottom-0 w-full md:w-[450px] bg-white shadow-2xl translate-x-full transition-transform duration-300 flex flex-col">
            <div class="p-6 border-b border-gray-100 flex justify-between items-center">
                <h2 class="font-serif italic text-2xl">New Item</h2>
                <button onclick="closeAddModal()"><i data-lucide="x" class="w-6 h-6"></i></button>
            </div>
            <div class="flex-grow overflow-y-auto p-6 space-y-6">
                <div>
                    <label class="text-xs font-bold text-gray-400 block mb-1">SOURCE URL</label>
                    <div class="flex gap-2">
                        <input type="url" id="inp-url" class="flex-1 border border-gray-200 rounded p-2 text-sm" placeholder="Paste link...">
                        <button onclick="checkUrl()" class="bg-black text-white px-3 rounded text-xs font-bold">CHECK</button>
                    </div>
                </div>
                <div>
                    <label class="text-xs font-bold text-gray-400 block mb-1">IMAGE</label>
                    <div class="flex gap-3">
                        <div class="w-20 h-20 bg-gray-100 rounded overflow-hidden flex items-center justify-center border border-gray-200">
                            <img id="preview-img" class="w-full h-full object-cover hidden">
                            <i id="preview-icon" data-lucide="image" class="w-6 h-6 text-gray-400"></i>
                        </div>
                        <div class="flex-1 space-y-2">
                            <input type="text" id="inp-img-url" class="w-full border border-gray-200 rounded p-2 text-xs" placeholder="Image URL" oninput="updatePreview(this.value)">
                            <input type="file" id="inp-file" class="hidden" onchange="handleFile(event)">
                            <button onclick="document.getElementById('inp-file').click()" class="bg-gray-100 border border-gray-200 px-3 py-1 rounded text-xs">Upload File</button>
                        </div>
                    </div>
                </div>
                <div>
                    <label class="text-xs font-bold text-gray-400 block mb-1">CONTENT</label>
                    <textarea id="inp-content" rows="4" class="w-full border border-gray-200 rounded p-2 text-sm" placeholder="Text content..."></textarea>
                </div>
                <div class="space-y-4">
                    <input type="text" id="inp-title" class="w-full border-b border-gray-200 py-2 font-serif text-lg outline-none" placeholder="Title">
                    <div class="flex gap-4">
                        <select id="inp-type" class="w-1/2 border-b border-gray-200 py-2 text-sm bg-transparent">
                            <option value="news">Article</option>
                            <option value="video">Video</option>
                            <option value="image">Image</option>
                            <option value="paper">Paper</option>
                            <option value="custom">Other</option>
                        </select>
                        <input type="text" id="inp-folder" class="w-1/2 border-b border-gray-200 py-2 text-sm" placeholder="Folder" list="folder-list-opts">
                        <datalist id="folder-list-opts"></datalist>
                    </div>
                    <textarea id="inp-summary" rows="2" class="w-full border border-gray-200 rounded p-2 text-sm" placeholder="Summary"></textarea>
                </div>
            </div>
            <div class="p-6 border-t border-gray-100">
                <button onclick="saveItem()" class="w-full bg-black text-white py-4 rounded font-bold hover:bg-gray-800">SAVE ITEM</button>
            </div>
        </div>
    </div>

    <div id="settings-modal" class="fixed inset-0 hidden flex items-center justify-center bg-black/40 backdrop-blur-sm">
        <div class="bg-white w-80 rounded-xl p-6 shadow-2xl">
            <h3 class="font-serif italic text-2xl mb-4">Settings</h3>
            <div class="space-y-3">
                <button onclick="exportData()" class="w-full p-3 bg-gray-50 border border-gray-200 rounded flex items-center justify-center gap-2 hover:bg-gray-100 font-bold text-sm">
                    <i data-lucide="download" class="w-4 h-4"></i> Backup Data
                </button>
                <button onclick="document.getElementById('import-file-input').click()" class="w-full p-3 bg-black text-white rounded flex items-center justify-center gap-2 hover:bg-gray-800 font-bold text-sm">
                    <i data-lucide="upload" class="w-4 h-4"></i> Restore Data
                </button>
            </div>
            <button onclick="closeSettingsModal()" class="w-full mt-6 text-xs text-gray-400 font-bold hover:text-black">CLOSE</button>
        </div>
    </div>

    <div id="detail-view-modal" class="fixed inset-0 hidden bg-white flex flex-col">
        <div class="px-6 py-4 border-b border-gray-100 flex justify-between items-center">
            <button onclick="closeDetailView()"><i data-lucide="arrow-left" class="w-6 h-6"></i></button>
            <button onclick="openTypeSelect()" class="px-3 py-1 bg-gray-100 rounded-full text-xs font-bold text-gray-500 hover:bg-black hover:text-white transition flex items-center gap-1">
                <span id="dt-badge">ITEM</span> <i data-lucide="chevron-down" class="w-3 h-3"></i>
            </button>
            <div class="w-6"></div>
        </div>
        <div class="flex-grow overflow-y-auto p-6 custom-scrollbar">
            <div class="max-w-3xl mx-auto space-y-6">
                <input type="text" id="dt-title" class="w-full text-center font-serif italic text-3xl outline-none bg-transparent border-b border-transparent focus:border-gray-200 transition" onchange="saveDetailTitle(this.value)">
                
                <div class="flex flex-col md:flex-row gap-6">
                    <div class="w-full md:w-1/2 bg-gray-100 rounded-lg overflow-hidden relative group aspect-video">
                        <a id="dt-link" href="#" target="_blank" class="block w-full h-full">
                            <img id="dt-img" class="w-full h-full object-contain bg-gray-200" src="">
                            <div id="dt-fallback" class="absolute inset-0 flex items-center justify-center text-gray-400 hidden"><i data-lucide="image" class="w-12 h-12"></i></div>
                        </a>
                    </div>
                    <div class="w-full md:w-1/2 flex flex-col">
                        <div class="flex border-b border-gray-100 mb-2">
                            <button id="btn-sum" onclick="showTab('sum')" class="flex-1 pb-2 border-b-2 border-black font-bold text-xs">Summary</button>
                            <button id="btn-full" onclick="showTab('full')" class="flex-1 pb-2 border-b-2 border-transparent text-gray-400 font-bold text-xs">Full Text</button>
                        </div>
                        <div id="txt-sum" class="flex-grow p-4 bg-gray-50 rounded text-sm text-gray-700 overflow-y-auto max-h-60"></div>
                        <div id="txt-full" class="flex-grow p-4 bg-white border border-gray-100 rounded text-sm hidden overflow-y-auto max-h-60"></div>
                    </div>
                </div>
                <div class="bg-yellow-50 p-4 rounded border border-yellow-100">
                    <div class="flex justify-between mb-2 text-xs font-bold text-yellow-600"><span>MEMO</span><button onclick="saveDetailMemo()">SAVE</button></div>
                    <textarea id="dt-memo" class="w-full bg-transparent resize-none outline-none text-sm" rows="3"></textarea>
                </div>
            </div>
        </div>
    </div>

    <div id="menu-modal" class="fixed inset-0 hidden z-[350]">
        <div class="absolute inset-0 bg-black/20" onclick="closeMenuModal()"></div>
        <div class="absolute bottom-0 w-full bg-white rounded-t-xl p-6 transform transition-transform duration-300 translate-y-full" id="menu-sheet">
            <h3 id="menu-head" class="text-lg font-bold mb-4 truncate">Options</h3>
            <div id="menu-main" class="grid grid-cols-4 gap-4 mb-4">
                <button onclick="actionOpen()" class="flex flex-col items-center gap-1"><div class="w-12 h-12 bg-gray-100 rounded-full flex items-center justify-center"><i data-lucide="maximize-2" class="w-5 h-5"></i></div><span class="text-[10px]">Open</span></button>
                <button onclick="actionThumb()" class="flex flex-col items-center gap-1"><div class="w-12 h-12 bg-blue-50 text-blue-600 rounded-full flex items-center justify-center"><i data-lucide="image" class="w-5 h-5"></i></div><span class="text-[10px]">Thumb</span></button>
                <button onclick="actionType()" class="flex flex-col items-center gap-1"><div class="w-12 h-12 bg-orange-50 text-orange-600 rounded-full flex items-center justify-center"><i data-lucide="toggle-left" class="w-5 h-5"></i></div><span class="text-[10px]">Type</span></button>
                <button onclick="actionFolder()" class="flex flex-col items-center gap-1"><div class="w-12 h-12 bg-green-50 text-green-600 rounded-full flex items-center justify-center"><i data-lucide="folder" class="w-5 h-5"></i></div><span class="text-[10px]">Move</span></button>
                <button onclick="actionDelete()" class="flex flex-col items-center gap-1"><div class="w-12 h-12 bg-red-50 text-red-600 rounded-full flex items-center justify-center"><i data-lucide="trash-2" class="w-5 h-5"></i></div><span class="text-[10px]">Delete</span></button>
            </div>
            <div id="menu-sub-type" class="hidden space-y-2">
                <p class="text-xs font-bold text-gray-400 mb-2">SELECT TYPE</p>
                <div class="grid grid-cols-2 gap-2">
                    <button onclick="setType('video')" class="p-3 border rounded text-sm hover:bg-black hover:text-white">Video</button>
                    <button onclick="setType('news')" class="p-3 border rounded text-sm hover:bg-black hover:text-white">Article</button>
                    <button onclick="setType('image')" class="p-3 border rounded text-sm hover:bg-black hover:text-white">Image</button>
                    <button onclick="setType('paper')" class="p-3 border rounded text-sm hover:bg-black hover:text-white">Paper</button>
                </div>
                <button onclick="showMainMenu()" class="w-full py-3 text-sm font-bold text-gray-400">BACK</button>
            </div>
            <div id="menu-sub-folder" class="hidden space-y-2">
                <p class="text-xs font-bold text-gray-400 mb-2">SELECT FOLDER</p>
                <div id="menu-folder-grid" class="grid grid-cols-2 gap-2 max-h-40 overflow-y-auto"></div>
                <button onclick="showMainMenu()" class="w-full py-3 text-sm font-bold text-gray-400">BACK</button>
            </div>
            <button onclick="closeMenuModal()" class="w-full py-3 bg-gray-100 rounded font-bold text-sm mt-2">CANCEL</button>
        </div>
    </div>

    <div id="folder-modal" class="fixed inset-0 hidden flex items-center justify-center bg-black/40">
        <div class="bg-white p-6 rounded-lg w-80">
            <h3 class="text-lg font-bold mb-4">New Folder</h3>
            <input type="text" id="new-folder-name" class="w-full border p-2 rounded mb-4" placeholder="Name">
            <button onclick="createNewFolder()" class="w-full bg-black text-white py-2 rounded font-bold">Create</button>
            <button onclick="document.getElementById('folder-modal').classList.add('hidden')" class="w-full mt-2 text-xs text-gray-400 font-bold">CANCEL</button>
        </div>
    </div>

    <script>
        // --- DATA & INIT ---
        window.allScraps = [];
        window.folders = new Set(['General', 'Ideas', 'References']);
        window.currentScrap = null;
        window.currTab = 'scraps';

        // Safe Initialization
        window.onload = function() {
            try {
                loadData();
                lucide.createIcons();
            } catch(e) {
                console.error("Init Error:", e);
                // Emergency Reset if critical failure
                window.allScraps = [];
                render();
            }
        };

        function loadData() {
            const s = localStorage.getItem('ca_scraps');
            const f = localStorage.getItem('ca_folders');
            
            if(s) {
                try {
                    window.allScraps = JSON.parse(s);
                    // AUTO FIX: Old YouTube Thumbs
                    window.allScraps.forEach(item => {
                        if(item.type === 'video' && item.imageUrl && item.imageUrl.includes('hqdefault.jpg')) {
                            item.imageUrl = item.imageUrl.replace('hqdefault.jpg', 'mqdefault.jpg');
                        }
                    });
                } catch(e) { window.allScraps = []; }
            }
            if(f) {
                try { JSON.parse(f).forEach(x => window.folders.add(x)); } catch(e){}
            }
            render();
        }

        function saveData() {
            localStorage.setItem('ca_scraps', JSON.stringify(window.allScraps));
            localStorage.setItem('ca_folders', JSON.stringify(Array.from(window.folders)));
        }

        // --- NAVIGATION ---
        window.enterApp = () => {
            document.getElementById('intro-scene').style.opacity = '0';
            document.getElementById('intro-scene').style.pointerEvents = 'none';
            document.getElementById('app-content').classList.add('mode-app-active');
        };
        window.returnToIntro = () => {
            document.getElementById('app-content').classList.remove('mode-app-active');
            document.getElementById('intro-scene').style.opacity = '1';
            document.getElementById('intro-scene').style.pointerEvents = 'auto';
        };
        window.switchTab = (tab) => {
            window.currTab = tab;
            ['scraps','folders','favorites'].forEach(t => {
                const el = document.getElementById(`tab-${t}`);
                if(t===tab) { el.classList.add('active'); el.classList.remove('inactive'); }
                else { el.classList.add('inactive'); el.classList.remove('active'); }
            });
            document.getElementById('view-grid').classList.add('hidden');
            document.getElementById('view-folders').classList.add('hidden');
            document.getElementById('view-folder-detail').classList.add('hidden');
            document.getElementById('folder-back-btn').classList.add('hidden');
            document.getElementById('view-title').textContent = tab === 'folders' ? 'My Folders' : (tab === 'favorites' ? 'Favorites' : 'All Scraps');

            if(tab === 'folders') document.getElementById('view-folders').classList.remove('hidden');
            else {
                document.getElementById('view-grid').classList.remove('hidden');
                render();
            }
            if(tab === 'folders') renderFolders();
        };

        // --- RENDER ---
        function render() {
            const grid = document.getElementById('scrap-grid');
            grid.innerHTML = '';
            let list = window.allScraps;
            
            if(window.currTab === 'favorites') list = list.filter(x => x.isFav);
            const search = document.querySelector('input[placeholder="Search..."]').value.toLowerCase();
            if(search) list = list.filter(x => x.title.toLowerCase().includes(search));

            if(list.length === 0) {
                document.getElementById('empty-state').classList.remove('hidden');
            } else {
                document.getElementById('empty-state').classList.add('hidden');
                list.forEach(item => {
                    grid.appendChild(createCard(item));
                });
            }
            lucide.createIcons();
        }

        function createCard(item) {
            const el = document.createElement('div');
            el.className = "bg-white rounded shadow-sm border border-gray-100 overflow-hidden cursor-pointer relative group";
            el.innerHTML = `
                <div class="aspect-[4/3] bg-gray-200 relative overflow-hidden">
                    <img src="${item.imageUrl}" class="w-full h-full object-contain" onerror="this.style.display='none';this.nextElementSibling.style.display='flex'">
                    <div class="absolute inset-0 flex items-center justify-center text-gray-400 hidden"><i data-lucide="${getTypeIcon(item.type)}" class="w-8 h-8"></i></div>
                    <div class="absolute top-2 right-2 p-1 bg-black/20 rounded-full backdrop-blur-sm ${item.isFav ? 'text-red-500' : 'text-white'}">
                        <i data-lucide="heart" class="w-3 h-3 ${item.isFav?'fill-current':''}"></i>
                    </div>
                </div>
                <div class="p-3">
                    <div class="text-[10px] text-gray-400 font-bold uppercase mb-1">${item.folder}</div>
                    <h3 class="font-serif font-bold text-sm leading-snug line-clamp-2">${item.title}</h3>
                </div>
            `;
            
            // Long Press Logic
            let timer;
            const start = () => { timer = setTimeout(() => { openMenu(item); }, 500); el.classList.add('card-press-active'); };
            const end = () => { clearTimeout(timer); el.classList.remove('card-press-active'); };
            const click = () => { if(!timer) return; clearTimeout(timer); openDetail(item); };
            
            el.addEventListener('touchstart', start);
            el.addEventListener('touchend', (e) => { end(); if(e.changedTouches.length>0) click(); }); // Simplified touch logic
            el.addEventListener('mousedown', start);
            el.addEventListener('mouseup', () => { end(); openDetail(item); });
            el.addEventListener('mouseleave', end);
            el.oncontextmenu = (e) => { e.preventDefault(); openMenu(item); }; // Right click opens menu

            return el;
        }

        function renderFolders() {
            const grid = document.getElementById('folder-list');
            grid.innerHTML = '';
            window.folders.forEach(f => {
                const count = window.allScraps.filter(x => x.folder === f).length;
                const el = document.createElement('div');
                el.className = "bg-white p-6 rounded shadow-sm border border-gray-100 flex flex-col items-center justify-center cursor-pointer hover:shadow-md";
                el.onclick = () => openFolderDetail(f);
                el.innerHTML = `<i data-lucide="folder" class="w-8 h-8 text-gray-300 mb-2"></i><span class="font-serif font-bold">${f}</span><span class="text-xs text-gray-400">${count} items</span>`;
                grid.appendChild(el);
            });
            lucide.createIcons();
        }

        // --- ADD MODAL ---
        window.openAddModal = () => {
            document.getElementById('add-modal').classList.remove('hidden');
            setTimeout(() => document.getElementById('add-panel').classList.remove('translate-x-full'), 10);
            renderFolderOpts();
        };
        window.closeAddModal = () => {
            document.getElementById('add-panel').classList.add('translate-x-full');
            setTimeout(() => document.getElementById('add-modal').classList.add('hidden'), 300);
            resetForm();
        };
        window.checkUrl = () => {
            const url = document.getElementById('inp-url').value;
            // Robust Youtube Regex
            const yt = url.match(/^.*(youtu.be\/|v\/|u\/\w\/|embed\/|watch\?v=|\&v=)([^#\&\?]*).*/);
            if(yt && yt[2].length===11) {
                document.getElementById('inp-type').value = 'video';
                const thumb = `https://img.youtube.com/vi/${yt[2]}/mqdefault.jpg`;
                document.getElementById('inp-img-url').value = thumb;
                updatePreview(thumb);
            } else if(url.match(/\.(jpeg|jpg|gif|png)$/i)) {
                document.getElementById('inp-type').value = 'image';
                document.getElementById('inp-img-url').value = url;
                updatePreview(url);
            }
        };
        window.updatePreview = (url) => {
            const img = document.getElementById('preview-img');
            if(url) { img.src = url; img.classList.remove('hidden'); document.getElementById('preview-icon').classList.add('hidden'); }
        };
        window.saveItem = () => {
            const title = document.getElementById('inp-title').value;
            if(!title) return alert('Title required');
            const item = {
                id: Date.now().toString(),
                url: document.getElementById('inp-url').value,
                imageUrl: document.getElementById('inp-img-url').value,
                title: title,
                content: document.getElementById('inp-content').value,
                summary: document.getElementById('inp-summary').value,
                type: document.getElementById('inp-type').value,
                folder: document.getElementById('inp-folder').value || 'General',
                tags: [],
                isFav: false,
                memo: ''
            };
            window.folders.add(item.folder);
            window.allScraps.unshift(item);
            saveData();
            closeAddModal();
            if(window.currTab === 'scraps') render();
            else if(window.currTab === 'folders') renderFolders();
        };
        window.resetForm = () => {
            document.querySelectorAll('#add-panel input, #add-panel textarea').forEach(i => i.value='');
            document.getElementById('preview-img').classList.add('hidden');
            document.getElementById('preview-icon').classList.remove('hidden');
        };
        function renderFolderOpts() {
            const dl = document.getElementById('folder-list-opts');
            dl.innerHTML = '';
            window.folders.forEach(f => {
                const opt = document.createElement('option'); opt.value = f; dl.appendChild(opt);
            });
        }

        // --- DETAILS ---
        window.openDetail = (item) => {
            window.currentScrap = item;
            const m = document.getElementById('detail-view-modal');
            m.classList.remove('hidden');
            
            document.getElementById('dt-title').value = item.title;
            document.getElementById('dt-badge').textContent = item.type.toUpperCase();
            document.getElementById('dt-link').href = item.url || '#';
            
            const img = document.getElementById('dt-img');
            if(item.imageUrl) {
                img.src = item.imageUrl;
                img.style.display = 'block';
                document.getElementById('dt-fallback').classList.add('hidden');
            } else {
                img.style.display = 'none';
                document.getElementById('dt-fallback').classList.remove('hidden');
            }
            
            document.getElementById('txt-sum').textContent = item.summary || 'No summary.';
            document.getElementById('txt-full').textContent = item.content || '';
            document.getElementById('dt-memo').value = item.memo || '';
            
            showTab('sum');
            lucide.createIcons();
        };
        window.closeDetailView = () => document.getElementById('detail-view-modal').classList.add('hidden');
        
        window.saveDetailTitle = (val) => { if(window.currentScrap) { window.currentScrap.title = val; saveData(); render(); } };
        window.saveDetailMemo = () => { if(window.currentScrap) { window.currentScrap.memo = document.getElementById('dt-memo').value; saveData(); alert('Saved'); } };
        
        window.showTab = (t) => {
            if(t === 'sum') {
                document.getElementById('txt-sum').classList.remove('hidden');
                document.getElementById('txt-full').classList.add('hidden');
                document.getElementById('btn-sum').classList.replace('border-transparent','border-black');
                document.getElementById('btn-full').classList.replace('border-black','border-transparent');
            } else {
                document.getElementById('txt-sum').classList.add('hidden');
                document.getElementById('txt-full').classList.remove('hidden');
                document.getElementById('btn-full').classList.replace('border-transparent','border-black');
                document.getElementById('btn-sum').classList.replace('border-black','border-transparent');
            }
        };

        // --- MENU ---
        window.openMenu = (item) => {
            window.currentScrap = item;
            document.getElementById('menu-head').textContent = item.title;
            document.getElementById('menu-modal').classList.remove('hidden');
            setTimeout(() => document.getElementById('menu-sheet').classList.remove('translate-y-full'), 10);
            showMainMenu();
        };
        window.closeMenuModal = () => {
            document.getElementById('menu-sheet').classList.add('translate-y-full');
            setTimeout(() => document.getElementById('menu-modal').classList.add('hidden'), 300);
        };
        
        window.showMainMenu = () => {
            document.getElementById('menu-main').classList.remove('hidden');
            document.getElementById('menu-sub-type').classList.add('hidden');
            document.getElementById('menu-sub-folder').classList.add('hidden');
        };
        
        window.actionOpen = () => { closeMenuModal(); openDetail(window.currentScrap); };
        window.actionThumb = () => { document.getElementById('hidden-thumb-input').click(); };
        window.actionType = () => { 
            document.getElementById('menu-main').classList.add('hidden');
            document.getElementById('menu-sub-type').classList.remove('hidden');
        };
        window.actionFolder = () => {
            document.getElementById('menu-main').classList.add('hidden');
            document.getElementById('menu-sub-folder').classList.remove('hidden');
            const g = document.getElementById('menu-folder-grid');
            g.innerHTML = '';
            window.folders.forEach(f => {
                const b = document.createElement('button');
                b.className = "p-3 bg-gray-50 border rounded text-xs font-bold";
                b.textContent = f;
                b.onclick = () => { window.currentScrap.folder = f; saveData(); render(); closeMenuModal(); };
                g.appendChild(b);
            });
        };
        window.actionDelete = () => {
            if(confirm('Delete?')) {
                window.allScraps = window.allScraps.filter(x => x.id !== window.currentScrap.id);
                saveData(); render(); closeMenuModal();
                // If detail is open, close it
                if(!document.getElementById('detail-view-modal').classList.contains('hidden')) closeDetailView();
            }
        };
        
        window.setType = (type) => {
            window.currentScrap.type = type;
            saveData(); render(); closeMenuModal();
            if(!document.getElementById('detail-view-modal').classList.contains('hidden')) {
                document.getElementById('dt-badge').textContent = type.toUpperCase();
            }
        };
        
        // --- SETTINGS (SYNC) ---
        window.openSettingsModal = () => document.getElementById('settings-modal').classList.remove('hidden');
        window.closeSettingsModal = () => document.getElementById('settings-modal').classList.add('hidden');
        window.exportData = () => {
            const d = JSON.stringify({s: window.allScraps, f: Array.from(window.folders)});
            const b = new Blob([d], {type:'application/json'});
            const a = document.createElement('a'); a.href = URL.createObjectURL(b); a.download = 'archive.json';
            a.click();
        };
        window.importData = (e) => {
            const f = e.target.files[0];
            if(!f) return;
            const r = new FileReader();
            r.onload = (evt) => {
                try {
                    const d = JSON.parse(evt.target.result);
                    window.allScraps = d.s || [];
                    window.folders = new Set(d.f || []);
                    saveData(); loadData();
                    alert('Restored!'); closeSettingsModal();
                } catch(x) { alert('Error'); }
            };
            r.readAsText(f);
        };

        // --- UTILS ---
        window.handleThumbUpdate = (e) => {
            const f = e.target.files[0];
            if(f && window.currentScrap) {
                const r = new FileReader();
                r.onload = (ev) => {
                    window.currentScrap.imageUrl = ev.target.result;
                    saveData(); render(); closeMenuModal();
                    if(!document.getElementById('detail-view-modal').classList.contains('hidden')) {
                        document.getElementById('dt-img').src = ev.target.result;
                    }
                };
                r.readAsDataURL(f);
            }
        };
        
        window.toggleFavoriteById = (id) => { /* Helper if needed */ };
        
        function getTypeIcon(t) {
            if(t==='video') return 'youtube';
            if(t==='news') return 'newspaper';
            if(t==='image') return 'image';
            return 'box';
        }
        
        // --- SEARCH ---
        window.handleSearch = (e) => { render(); };
        
        // --- FOLDER MODAL ---
        window.openFolderModal = () => document.getElementById('folder-modal').classList.remove('hidden');
        window.createNewFolder = () => {
            const n = document.getElementById('new-folder-name').value;
            if(n) { window.folders.add(n); saveData(); renderFolders(); document.getElementById('folder-modal').classList.add('hidden'); }
        };
        
        // --- FOLDER DETAIL ---
        window.openFolderDetail = (fname) => {
            const v = document.getElementById('view-folder-detail');
            v.classList.remove('hidden');
            document.getElementById('folder-detail-title').textContent = fname;
            const g = document.getElementById('folder-detail-grid');
            g.innerHTML = '';
            window.allScraps.filter(x => x.folder === fname).forEach(i => g.appendChild(createCard(i)));
            lucide.createIcons();
        };
        window.closeFolderDetail = () => document.getElementById('view-folder-detail').classList.add('hidden');
        window.openTypeSelect = () => { openMenu(window.currentScrap); actionType(); }; // For detail view button
    </script>
</body>
</html>
