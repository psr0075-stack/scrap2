<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    
    <title>Archive v11.2 (Final Polish)</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600&family=Playfair+Display:ital,wght@0,400;0,600;1,400;1,600&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/lucide@latest"></script>
    
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database-compat.js"></script>

    <style>
        body { font-family: 'Inter', sans-serif; overflow: hidden; margin: 0; background-color: #f9fafb; color: #18181b; }
        .font-serif { font-family: 'Playfair Display', serif; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        
        /* 탭 스타일 */
        .folder-tab { 
            font-family: 'Playfair Display', serif; 
            font-style: italic; 
            font-size: 1.125rem; 
            padding-bottom: 0.5rem; 
            margin-right: 2rem;
            cursor: pointer; 
            transition: all 0.2s; 
            border-bottom: 2px solid transparent;
            color: #a1a1aa; 
        }
        .folder-tab.active { color: #000000; font-weight: 700; border-bottom-color: #000000; }
        .folder-tab:hover { color: #52525b; }

        button:active { transform: scale(0.95); transition: 0.1s; }
        
        #detail-image-container { background-color: #f3f4f6; display: flex; align-items: center; justify-content: center; overflow: hidden; border: 1px solid #e5e7eb; }
        #detail-image { width: 100%; height: 100%; object-fit: contain; display: block; }

        .edit-input { border: 1px solid #e5e7eb; background: #fff; padding: 4px 8px; width: 100%; border-radius: 4px; }
        .edit-textarea { border: 1px solid #e5e7eb; background: #fff; padding: 8px; width: 100%; border-radius: 4px; min-height: 100px; }
    </style>
</head>
<body class="h-screen w-screen overflow-hidden flex flex-col bg-[#f9fafb]">
    
    <input type="file" id="hidden-thumb-input" accept="image/*" class="hidden" onchange="handleThumbUpdate(event)">
    <div id="status-bar" class="hidden"></div>

    <div class="pt-8 px-8 flex flex-col select-none z-50 shrink-0">
        <div class="flex justify-end items-center gap-4 mb-2">
             <button class="p-2 hover:bg-gray-100 rounded-full transition"><i data-lucide="search" class="w-5 h-5 text-gray-600"></i></button>
             <button onclick="openAddModal()" class="p-2 hover:bg-gray-100 rounded-full transition"><i data-lucide="plus" class="w-5 h-5 text-gray-900"></i></button>
        </div>

        <div>
            <h1 class="font-serif italic text-4xl text-black mb-6 font-bold">Scraps</h1>
            <div class="flex items-center border-b border-gray-200">
                <button onclick="switchTab('scraps')" id="tab-scraps" class="folder-tab active">Scraps</button>
                <button onclick="switchTab('folders')" id="tab-folders" class="folder-tab">Folders</button>
                <button onclick="switchTab('favorites')" id="tab-favorites" class="folder-tab">Favorites</button>
            </div>
        </div>
    </div>

    <div class="flex-grow relative overflow-hidden bg-[#f9fafb] z-10 flex flex-col">
        <div id="sub-header" class="px-8 py-4 flex items-center justify-between z-20 shrink-0 hidden">
             <div class="flex items-center">
                <button id="folder-back-btn" onclick="closeFolderDetail()" class="mr-3 p-2 hover:bg-gray-100 rounded-full"><i data-lucide="arrow-left" class="w-5 h-5 text-black"></i></button>
                <div class="flex items-center gap-2">
                    <h2 id="view-title" class="font-serif italic text-xl text-black">All Scraps</h2>
                    <button id="rename-folder-btn" onclick="openRenameModal()" class="p-1.5 text-gray-400 hover:text-black hover:bg-gray-100 rounded-full transition"><i data-lucide="pencil" class="w-3 h-3"></i></button>
                </div>
            </div>
            <div class="relative">
                <i data-lucide="search" class="absolute left-3 top-2.5 w-4 h-4 text-gray-400"></i>
                <input type="text" oninput="handleSearchInput(event)" placeholder="Search..." class="pl-9 pr-4 py-2 bg-white border border-gray-200 rounded-sm text-sm focus:border-black w-32 focus:w-48 transition-all outline-none">
            </div>
        </div>

        <div class="relative flex-grow overflow-hidden">
            <div id="view-grid" class="absolute inset-0 overflow-y-auto no-scrollbar p-8 pb-32">
                <div id="scrap-grid" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 xl:grid-cols-5 2xl:grid-cols-6 gap-8"></div>
                <div id="empty-state" class="hidden h-full flex flex-col items-center justify-center text-gray-400 pb-20">
                    <i data-lucide="layers" class="w-10 h-10 mb-4 opacity-20 text-black"></i>
                    <p class="text-sm font-light tracking-widest uppercase">Empty Collection</p>
                </div>
            </div>
            
            <div id="view-folders" class="absolute inset-0 overflow-y-auto no-scrollbar p-8 pb-32 hidden">
                <div class="mb-8">
                    <button onclick="openCreateFolderModal()" class="flex items-center space-x-2 text-sm font-bold text-black border border-gray-300 rounded-sm px-6 py-3 bg-white hover:bg-gray-50 shadow-sm w-full md:w-auto justify-center transition">
                        <i data-lucide="folder-plus" class="w-4 h-4"></i>
                        <span>New Folder</span>
                    </button>
                </div>
                <div id="folder-list" class="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-6 gap-6"></div>
            </div>
            
            <div id="view-folder-detail" class="absolute inset-0 overflow-y-auto no-scrollbar p-8 pb-32 hidden">
                  <div id="folder-detail-grid" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 xl:grid-cols-5 gap-8"></div>
                  <div id="folder-empty-state" class="hidden h-full flex flex-col items-center justify-center text-gray-400 pb-20"><p class="text-sm font-light tracking-widest uppercase">No items in this folder</p></div>
            </div>
        </div>
    </div>

    <div id="add-modal" class="fixed inset-0 hidden z-[200]">
        <div class="absolute inset-0 bg-black/20 backdrop-blur-sm" onclick="closeAddModal()"></div>
        <div class="absolute inset-y-0 right-0 w-full md:w-[500px] bg-white shadow-2xl transform translate-x-full transition-transform duration-500 flex flex-col" id="add-panel">
            <div class="px-8 py-6 border-b border-gray-100 flex justify-between items-center bg-white z-10">
                <h2 class="font-serif italic text-2xl text-black">New Item</h2>
                <div class="flex items-center space-x-4">
                    <button type="button" id="new-favorite-btn" onclick="toggleNewFavorite()" class="text-gray-400 hover:text-red-500 transition"><i data-lucide="heart" class="w-5 h-5"></i></button>
                    <button onclick="resetForm()" class="p-2 hover:bg-gray-100 rounded-full transition"><i data-lucide="rotate-ccw" class="w-5 h-5"></i></button>
                    <button onclick="closeAddModal()" class="p-2 hover:bg-gray-100 rounded-full transition"><i data-lucide="x" class="w-5 h-5"></i></button>
                </div>
            </div>
            
            <div class="flex-grow overflow-y-auto p-8 space-y-6 custom-scrollbar">
                <div class="space-y-2 p-4 bg-gray-50 rounded-sm border border-gray-100">
                    <label class="block text-xs font-bold text-gray-400 uppercase tracking-wider">Media Source (URL)</label>
                    <div class="flex gap-2">
                        <input type="url" id="input-url" class="flex-1 bg-white border border-gray-200 rounded-sm px-4 py-2 text-sm" placeholder="URL...">
                        <button type="button" onclick="handleMediaProcess()" class="bg-white border border-gray-200 text-black px-4 rounded-sm text-xs font-bold">Check</button>
                    </div>
                </div>
                
                <div class="space-y-2">
                    <label class="block text-[10px] font-bold text-gray-400 uppercase tracking-wider">Image (SNS는 직접 업로드)</label>
                    <div class="flex gap-2">
                        <input type="text" id="input-image-url" class="flex-1 bg-gray-50 border-b border-gray-200 py-2 text-xs" placeholder="URL or Upload">
                        <button onclick="document.getElementById('hidden-thumb-input').click()" class="px-3 py-2 bg-gray-100 hover:bg-gray-200 rounded-sm text-gray-700 transition flex items-center gap-1 text-xs font-bold whitespace-nowrap" title="Upload Image">
                            <i data-lucide="image-plus" class="w-4 h-4"></i> Upload
                        </button>
                    </div>
                </div>

                <div class="space-y-2 relative">
                    <div class="flex justify-between items-center">
                        <label class="block text-[10px] font-bold text-blue-500 uppercase tracking-wider">AI Analysis</label>
                        <div class="flex gap-2 items-center">
                            <button onclick="checkAvailableModels()" class="flex items-center justify-center px-2 py-1 bg-blue-50 text-blue-600 rounded-sm text-[10px] font-bold hover:bg-blue-100 transition border border-blue-100">
                                <i data-lucide="search-code" class="w-3 h-3 mr-1"></i>모델확인
                            </button>
                            <select id="model-select" class="bg-gray-100 border-none text-[10px] rounded-sm py-1 px-2 font-bold text-gray-600 focus:ring-0 cursor-pointer w-24 truncate">
                                <option value="gemini-1.5-flash">Default</option>
                            </select>
                            <button onclick="handleAIAutoFill()" class="flex items-center space-x-1 px-3 py-1 bg-black text-white text-[10px] font-bold rounded-sm shadow hover:bg-gray-800 transition">
                                <i data-lucide="sparkles" class="w-3 h-3"></i><span>Auto-Fill</span>
                            </button>
                        </div>
                    </div>
                    <textarea id="input-content" rows="8" class="w-full bg-blue-50/20 border border-blue-100 rounded-sm p-4 text-sm leading-relaxed" placeholder="내용..."></textarea>
                </div>

                <div class="border-t border-gray-100 pt-6 space-y-6">
                    <div class="space-y-1">
                        <label class="text-[10px] font-bold text-gray-400 uppercase tracking-wider">Title</label>
                        <input type="text" id="input-title" class="w-full text-lg font-serif border-b border-gray-200 py-2 bg-transparent" placeholder="Entry Title">
                    </div>
                    
                    <div class="grid grid-cols-2 gap-4">
                        <div class="space-y-1">
                            <label class="text-[10px] font-bold text-gray-400 uppercase tracking-wider">Type</label>
                            <input type="text" id="input-type" list="type-options" class="w-full bg-transparent border-b border-gray-200 py-2 text-sm" placeholder="Select/Type">
                            <datalist id="type-options"><option value="News"><option value="Video"><option value="Social"><option value="Image"><option value="Paper"></datalist>
                        </div>
                        <div class="space-y-1">
                            <label class="text-[10px] font-bold text-gray-400 uppercase tracking-wider">Folder</label>
                            <input type="text" id="input-folder" list="folder-options" class="w-full bg-transparent border-b border-gray-200 py-2 text-sm" placeholder="Select/Type">
                            <datalist id="folder-options"></datalist>
                        </div>
                    </div>
                    <div class="space-y-1"><label class="text-[10px] font-bold text-gray-400 uppercase tracking-wider">Summary</label><textarea id="input-summary" rows="3" class="w-full bg-gray-50 rounded-sm p-4 text-sm"></textarea></div>
                    <div class="space-y-1"><label class="text-[10px] font-bold text-gray-400 uppercase tracking-wider">Memo</label><textarea id="input-memo" rows="2" class="w-full bg-yellow-50/50 rounded-sm p-4 text-sm"></textarea></div>
                </div>
            </div>
            <div class="p-6 border-t border-gray-50 bg-white">
                <button type="button" onclick="handleSaveScrap()" id="save-button" class="w-full bg-black text-white py-4 rounded-sm font-medium text-sm shadow-xl hover:bg-gray-800 transition">Save</button>
            </div>
        </div>
    </div>

    <div id="detail-view-modal" class="fixed inset-0 z-[300] hidden bg-white flex flex-col">
        <div class="px-6 py-4 border-b border-gray-100 flex items-center justify-between bg-white z-10 shrink-0">
            <button onclick="closeDetailView()" class="p-2 hover:bg-gray-50 rounded-full transition"><i data-lucide="arrow-left" class="w-6 h-6"></i></button>
            <div class="flex items-center gap-2">
                <button id="detail-edit-btn" onclick="toggleDetailEdit()" class="flex items-center gap-1 px-3 py-1.5 bg-gray-100 hover:bg-gray-200 rounded-full text-xs font-bold text-gray-700 transition">
                    <i data-lucide="edit-3" class="w-3 h-3"></i> <span>Edit</span>
                </button>
            </div>
            <div class="w-10"></div>
        </div>

        <div class="flex-grow overflow-y-auto p-6 md:p-12 pb-20 custom-scrollbar">
            <div class="max-w-6xl mx-auto">
                <div class="grid grid-cols-1 md:grid-cols-3 gap-8 md:gap-12">
                    <div class="col-span-1">
                        <div id="detail-image-container" class="aspect-[3/4] w-full rounded-sm cursor-pointer relative group" onclick="openSourceUrl()">
                            <img id="detail-image" class="transition duration-300">
                            <div class="absolute inset-0 bg-black/5 opacity-0 group-hover:opacity-100 transition flex items-center justify-center">
                                <span class="bg-white text-black text-xs font-bold px-3 py-2 rounded shadow-lg flex items-center gap-1">
                                    <i data-lucide="external-link" class="w-3 h-3"></i> Visit Link
                                </span>
                            </div>
                        </div>
                    </div>
                    <div class="col-span-1 md:col-span-2 flex flex-col gap-8">
                        <div>
                            <div class="flex items-center gap-3 mb-4">
                                <span id="detail-type-badge" class="px-2 py-1 bg-gray-100 text-[10px] font-bold uppercase tracking-wider rounded-sm text-gray-600">TYPE</span>
                            </div>
                            <h1 id="detail-title-input" class="text-3xl font-serif italic text-black leading-tight mb-6"></h1>
                            
                            <div class="bg-gray-50 p-6 rounded-sm border-l-4 border-black mb-8">
                                <label class="text-[10px] font-bold text-gray-400 uppercase tracking-wider block mb-2">Key Summary</label>
                                <div id="detail-summary-text" class="text-sm text-gray-800 leading-relaxed font-medium"></div>
                            </div>
                            
                            <div>
                                <label class="text-[10px] font-bold text-gray-400 uppercase tracking-wider block mb-3 border-b border-gray-100 pb-1">Full Content</label>
                                <div id="detail-full-text" class="text-sm text-gray-600 leading-relaxed whitespace-pre-line text-justify min-h-[50px]"></div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="mt-12 pt-8 border-t border-gray-100">
                    <label class="text-[10px] font-bold text-gray-400 uppercase tracking-wider block mb-3">Memo</label>
                    <div class="bg-yellow-50/50 p-6 rounded-sm border border-yellow-200/50 min-h-[100px]">
                        <div id="detail-memo-input" class="font-serif italic text-gray-800 text-sm whitespace-pre-wrap"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="menu-modal" class="fixed inset-0 hidden z-[400] flex items-end justify-center sm:items-center">
        <div class="absolute inset-0 bg-black/30 backdrop-blur-[2px]" onclick="closeMenuModal()"></div>
        <div class="relative bg-white w-full sm:w-[320px] sm:rounded-lg rounded-t-lg shadow-2xl p-4 overflow-hidden animate-slide-up sm:animate-none transform transition-all" id="menu-panel">
            <div class="flex items-center gap-3 p-2 mb-2 border-b border-gray-100 pb-4">
                <div id="menu-thumb" class="w-12 h-12 bg-gray-100 rounded-sm overflow-hidden flex-shrink-0"></div>
                <div class="overflow-hidden">
                    <h3 id="menu-title" class="font-bold text-sm truncate">Title</h3>
                    <p id="menu-folder" class="text-xs text-gray-400 truncate">Folder</p>
                </div>
            </div>
            
            <div class="space-y-1">
                <button onclick="menuAction('edit')" class="w-full flex items-center gap-3 p-3 hover:bg-gray-50 rounded-md text-left transition text-sm font-medium">
                    <i data-lucide="edit-3" class="w-4 h-4 text-gray-500"></i> Edit Content
                </button>
                <button onclick="menuAction('folder')" class="w-full flex items-center gap-3 p-3 hover:bg-gray-50 rounded-md text-left transition text-sm font-medium">
                    <i data-lucide="folder-input" class="w-4 h-4 text-gray-500"></i> Move Folder
                </button>
                <button onclick="menuAction('favorite')" class="w-full flex items-center gap-3 p-3 hover:bg-gray-50 rounded-md text-left transition text-sm font-medium">
                    <i data-lucide="heart" class="w-4 h-4 text-red-500"></i> Toggle Favorite
                </button>
                <div class="h-px bg-gray-100 my-1"></div>
                <button onclick="menuAction('delete')" class="w-full flex items-center gap-3 p-3 hover:bg-red-50 rounded-md text-left transition text-sm font-bold text-red-500">
                    <i data-lucide="trash-2" class="w-4 h-4"></i> Delete
                </button>
            </div>
            <button onclick="closeMenuModal()" class="w-full mt-2 py-3 text-xs font-bold text-gray-400 hover:text-black transition">CANCEL</button>
        </div>
    </div>

    <div id="folder-select-modal" class="fixed inset-0 hidden z-[450] flex items-center justify-center">
        <div class="absolute inset-0 bg-black/30 backdrop-blur-sm" onclick="closeFolderSelectModal()"></div>
        <div class="bg-white w-[300px] rounded-lg shadow-2xl p-6 relative z-10">
            <h3 class="font-serif italic text-xl font-bold mb-4 text-center">Move to...</h3>
            <div id="folder-select-list" class="space-y-2 max-h-[300px] overflow-y-auto custom-scrollbar">
                </div>
            <button onclick="closeFolderSelectModal()" class="w-full mt-4 py-2 text-xs font-bold text-gray-400 hover:bg-gray-50 rounded transition">CANCEL</button>
        </div>
    </div>

    <div id="folder-input-modal" class="fixed inset-0 z-[500] hidden flex items-center justify-center transition-opacity duration-200 opacity-0"><div class="absolute inset-0 bg-black/20 backdrop-blur-sm" onclick="closeFolderModal()"></div><div class="bg-white p-8 rounded-sm shadow-2xl w-[90%] max-w-sm relative z-10 border border-gray-100 transform transition-all duration-200 scale-95" id="folder-modal-content"><h3 id="folder-modal-title" class="font-serif italic text-2xl mb-6 text-center text-black">New Folder</h3><div class="space-y-4"><input type="text" id="folder-name-input" class="w-full border-b-2 border-gray-200 py-3 text-lg font-medium text-center focus:outline-none focus:border-black transition-colors bg-transparent placeholder-gray-300" placeholder="Type name..." onkeypress="handleFolderEnter(event)"><div class="flex gap-2 pt-4"><button onclick="closeFolderModal()" class="flex-1 py-3 text-xs font-bold text-gray-400 hover:bg-gray-50 rounded-sm transition">CANCEL</button><button onclick="submitFolderInput()" class="flex-1 bg-black text-white py-3 rounded-sm text-xs font-bold hover:bg-gray-800 shadow-lg transition transform active:scale-95">SAVE</button></div></div></div></div>

    <script>
        const firebaseConfig={apiKey:"AIzaSyBqbdAQoIbzGQnD3w35xYkjXWzjc1c8zDs",authDomain:"scrap-2e367.firebaseapp.com",databaseURL:"https://scrap-2e367-default-rtdb.firebaseio.com",projectId:"scrap-2e367",storageBucket:"scrap-2e367.firebasestorage.app",messagingSenderId:"930951535494",appId:"1:930951535494:web:a59f16f12576338bb5aa07",measurementId:"G-4HM5SEHP15"};
        let db=null;try{firebase.initializeApp(firebaseConfig);db=firebase.database();}catch(e){console.error(e);}

        window.allScraps=[];window.customFolders=new Set(['General','Design']);window.currentTab='scraps';window.currentScrap=null;window.currentFolderContext=null;let folderModalMode='create';let targetFolderOldName='';let isNewItemFavorite=false;let isDetailEditing=false;

        window.onload=function(){loadData();lucide.createIcons();};

        function getGeminiKey(){let k=localStorage.getItem('GEMINI_API_KEY');if(!k){k=prompt("Gemini API Key:");if(k&&k.trim()){localStorage.setItem('GEMINI_API_KEY',k.trim());return k.trim();}return null;}return k.trim();}
        window.resetApiKey=function(){const k=prompt("새 API Key:");if(k){localStorage.setItem('GEMINI_API_KEY',k.trim());alert("저장됨");}}
        window.checkAvailableModels=async function(){const k=getGeminiKey();if(!k)return;try{const r=await fetch(`https://generativelanguage.googleapis.com/v1beta/models?key=${k}`);const d=await r.json();if(d.models){const s=document.getElementById('model-select');s.innerHTML="";d.models.forEach(m=>{if(m.supportedGenerationMethods?.includes("generateContent")){const o=document.createElement('option');o.value=m.name.replace("models/","");o.text=m.name.replace("models/","");s.appendChild(o);}});alert(`✅ ${d.models.length}개 모델 로드`);}}catch(e){alert("오류: "+e.message);}}
        window.handleAIAutoFill=async function(){const c=document.getElementById('input-content').value;if(!c||c.length<5){alert("내용입력");return;}const k=getGeminiKey();if(!k)return;const m=document.getElementById('model-select').value||"gemini-1.5-flash";const b=document.querySelector('button[onclick="handleAIAutoFill()"]');const o=b.innerHTML;b.innerHTML=`...`;try{const r=await fetch(`https://generativelanguage.googleapis.com/v1beta/models/${m}:generateContent?key=${k}`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({contents:[{parts:[{text:`Analyze. ONLY JSON: title, summary(3sent), folder(1word), type(News/Video/Social/Image/Paper). Text: "${c.substring(0,3000)}"`}]}]})});const d=await r.json();let t=d.candidates[0].content.parts[0].text.replace(/```json/g,'').replace(/```/g,'').trim();const j=JSON.parse(t);if(j.title)document.getElementById('input-title').value=j.title;if(j.summary)document.getElementById('input-summary').value=j.summary;if(j.folder)document.getElementById('input-folder').value=j.folder;if(j.type)document.getElementById('input-type').value=j.type;}catch(e){alert(e.message);}finally{b.innerHTML=o;}}
        window.handleThumbUpdate=function(e){const f=e.target.files[0];if(f){const r=new FileReader();r.onload=(ev)=>document.getElementById('input-image-url').value=ev.target.result;r.readAsDataURL(f);}};
        window.handleMediaProcess=function(){const u=document.getElementById('input-url').value;if(u.includes('youtu')){const i=u.split('v=')[1]||u.split('/').pop();document.getElementById('input-image-url').value=`https://img.youtube.com/vi/${i.split('&')[0]}/mqdefault.jpg`;document.getElementById('input-type').value='Video';}else{alert("SNS/기타 링크는 이미지를 직접 업로드해주세요.");document.getElementById('input-type').value='Social';}}
        window.handleSaveScrap=function(){const t=document.getElementById('input-title').value;if(!t){alert("Title Required");return;}const f=document.getElementById('input-folder').value||'General';if(!window.customFolders.has(f)){window.customFolders.add(f);renderFolders();}const n={id:Date.now().toString(),title:t,summary:document.getElementById('input-summary').value,content:document.getElementById('input-content').value,sourceUrl:document.getElementById('input-url').value,imageUrl:document.getElementById('input-image-url').value,type:document.getElementById('input-type').value||'Note',folder:f,memo:document.getElementById('input-memo').value,isFavorite:isNewItemFavorite,createdAt:new Date().toISOString()};window.allScraps.unshift(n);saveData();closeAddModal();window.resetForm();switchTab('scraps');}
        function loadData(){if(!db)return;db.ref('scraps').on('value',s=>{window.allScraps=s.val()||[];renderScraps();});db.ref('folders').on('value',s=>{if(s.val())window.customFolders=new Set(s.val());renderFolders();updateFolderDropdown();});}
        function saveData(){if(!db)return;db.ref('scraps').set(window.allScraps);db.ref('folders').set(Array.from(window.customFolders));}
        window.switchTab=function(t){window.currentTab=t;document.querySelectorAll('.folder-tab').forEach(e=>e.classList.remove('active'));document.getElementById(`tab-${t}`).classList.add('active');if(t==='folders'){document.getElementById('view-grid').classList.add('hidden');document.getElementById('view-folders').classList.remove('hidden');renderFolders();}else{document.getElementById('view-grid').classList.remove('hidden');document.getElementById('view-folders').classList.add('hidden');renderScraps();}document.getElementById('view-folder-detail').classList.add('hidden');document.getElementById('sub-header').classList.add('hidden');}
        window.renderScraps=function(){const g=document.getElementById('scrap-grid');g.innerHTML='';let f=window.allScraps;if(window.currentTab==='favorites')f=f.filter(s=>s.isFavorite);if(window.searchText)f=f.filter(s=>s.title.toLowerCase().includes(window.searchText.toLowerCase()));f.forEach(i=>g.appendChild(createCardElement(i)));lucide.createIcons();if(f.length===0)document.getElementById('empty-state').classList.remove('hidden');else document.getElementById('empty-state').classList.add('hidden');}
        
        // [MODIFIED] Card UI Logic
        function createCardElement(i){
            const c=document.createElement('div');
            // Gray BG for video margins (Fix)
            const bgClass = 'bg-gray-100'; 
            
            c.className="relative group cursor-pointer w-full aspect-[3/4] bg-white rounded-sm shadow-sm border border-gray-200 overflow-hidden transition hover:shadow-md";
            
            let m;
            if(i.imageUrl) {
                // Video type or YouTube -> object-contain + gray bg
                // Others (Images) -> object-cover (Full Fill)
                const isVideo = i.type === 'Video' || i.sourceUrl?.includes('youtu');
                const fitClass = isVideo ? 'object-contain' : 'object-cover';
                m = `<div class="w-full h-full ${bgClass} flex items-center justify-center overflow-hidden"><img src="${i.imageUrl}" class="w-full h-full ${fitClass}"></div>`;
            } else {
                m=`<div class="w-full h-full flex flex-col items-center justify-center bg-gray-50 text-gray-300 gap-2"><i data-lucide="image" class="w-8 h-8"></i><span class="text-[10px] uppercase font-bold text-gray-400">${i.type}</span></div>`;
            }
            
            // Larger Title (text-lg + line-clamp-2)
            c.innerHTML=`<div class="h-[65%] w-full overflow-hidden relative">${m}</div><div class="h-[35%] p-5 flex flex-col justify-between bg-white"><h3 class="font-serif text-lg font-bold text-black leading-snug line-clamp-2">${i.title}</h3><div class="flex justify-between items-center"><span class="text-[11px] text-gray-400 uppercase truncate max-w-[80px] tracking-wider">${i.folder}</span>${i.isFavorite?'<i data-lucide="heart" class="w-4 h-4 text-red-500 fill-current"></i>':''}</div></div>`;
            c.onclick=()=>openDetailView(i);
            
            let t;
            c.addEventListener('touchstart',()=>t=setTimeout(()=>{openMenu(i)},600));
            c.addEventListener('touchend',()=>clearTimeout(t));
            c.addEventListener('contextmenu',e=>{e.preventDefault();openMenu(i);});
            return c;
        }

        function openMenu(item){
            window.currentScrap=item;
            document.getElementById('menu-title').textContent = item.title;
            document.getElementById('menu-folder').textContent = item.folder;
            // Thumb display in menu
            const isVideo = item.type === 'Video' || item.sourceUrl?.includes('youtu');
            const fitClass = isVideo ? 'object-contain' : 'object-cover';
            document.getElementById('menu-thumb').innerHTML = item.imageUrl ? `<img src="${item.imageUrl}" class="w-full h-full ${fitClass}">` : '';
            
            document.getElementById('menu-modal').classList.remove('hidden');
            lucide.createIcons();
        }
        
        window.menuAction = function(action) {
            const item = window.currentScrap;
            if(!item) return;
            
            if(action === 'delete') {
                if(confirm("Delete this item?")) {
                    window.allScraps = window.allScraps.filter(s => s.id !== item.id);
                    saveData();
                    if(document.getElementById('view-folder-detail').classList.contains('hidden')) renderScraps();
                    else openFolder(item.folder);
                }
                closeMenuModal();
            } else if(action === 'favorite') {
                item.isFavorite = !item.isFavorite;
                saveData();
                renderScraps();
                closeMenuModal();
            } else if(action === 'folder') {
                closeMenuModal();
                openFolderSelectModal();
            } else if(action === 'edit') {
                openDetailView(item);
                toggleDetailEdit();
                closeMenuModal();
            }
        }

        window.openFolderSelectModal = function() {
            const list = document.getElementById('folder-select-list');
            list.innerHTML = '';
            Array.from(window.customFolders).sort().forEach(f => {
                const btn = document.createElement('button');
                btn.className = "w-full text-left px-4 py-3 hover:bg-gray-100 rounded-sm font-medium text-sm flex items-center gap-2 transition";
                btn.innerHTML = `<i data-lucide="folder" class="w-4 h-4 text-gray-400"></i> ${f}`;
                btn.onclick = () => {
                    window.currentScrap.folder = f;
                    saveData();
                    renderScraps();
                    if(!document.getElementById('view-folder-detail').classList.contains('hidden')) {
                        openFolder(f); 
                    }
                    closeFolderSelectModal();
                };
                list.appendChild(btn);
            });
            document.getElementById('folder-select-modal').classList.remove('hidden');
            lucide.createIcons();
        }
        
        window.closeFolderSelectModal = function() {
            document.getElementById('folder-select-modal').classList.add('hidden');
        }

        window.toggleDetailEdit = function() {
            isDetailEditing = !isDetailEditing;
            const btn = document.getElementById('detail-edit-btn');
            const titleEl = document.getElementById('detail-title-input');
            const summaryEl = document.getElementById('detail-summary-text');
            const contentEl = document.getElementById('detail-full-text');
            const memoEl = document.getElementById('detail-memo-input');

            if(isDetailEditing) {
                btn.innerHTML = `<i data-lucide="save" class="w-3 h-3"></i> <span>Save</span>`;
                btn.classList.replace('bg-gray-100', 'bg-black');
                btn.classList.replace('text-gray-700', 'text-white');
                btn.classList.replace('hover:bg-gray-200', 'hover:bg-gray-800');
                titleEl.innerHTML = `<input type="text" class="edit-input text-3xl font-serif italic" value="${window.currentScrap.title}">`;
                summaryEl.innerHTML = `<textarea class="edit-textarea text-sm">${window.currentScrap.summary}</textarea>`;
                contentEl.innerHTML = `<textarea class="edit-textarea text-sm h-64">${window.currentScrap.content}</textarea>`;
                memoEl.innerHTML = `<textarea class="edit-textarea font-serif italic text-sm">${window.currentScrap.memo}</textarea>`;
            } else {
                const newTitle = titleEl.querySelector('input').value;
                const newSummary = summaryEl.querySelector('textarea').value;
                const newContent = contentEl.querySelector('textarea').value;
                const newMemo = memoEl.querySelector('textarea').value;
                window.currentScrap.title = newTitle;
                window.currentScrap.summary = newSummary;
                window.currentScrap.content = newContent;
                window.currentScrap.memo = newMemo;
                const idx = window.allScraps.findIndex(s => s.id === window.currentScrap.id);
                if(idx !== -1) window.allScraps[idx] = window.currentScrap;
                saveData();
                btn.innerHTML = `<i data-lucide="edit-3" class="w-3 h-3"></i> <span>Edit</span>`;
                btn.classList.replace('bg-black', 'bg-gray-100');
                btn.classList.replace('text-white', 'text-gray-700');
                btn.classList.replace('hover:bg-gray-800', 'hover:bg-gray-200');
                titleEl.textContent = newTitle;
                summaryEl.textContent = newSummary;
                contentEl.innerText = newContent;
                memoEl.innerText = newMemo;
                renderScraps();
            }
            lucide.createIcons();
        }

        window.renderFolders=function(){const l=document.getElementById('folder-list');l.innerHTML='';Array.from(window.customFolders).sort().forEach(f=>{const c=window.allScraps.filter(s=>s.folder===f).length,b=document.createElement('div');b.className="aspect-square bg-white border border-gray-200 rounded-sm flex flex-col items-center justify-center cursor-pointer hover:bg-gray-50 transition hover:shadow-sm";b.onclick=()=>openFolder(f);b.innerHTML=`<i data-lucide="folder" class="w-10 h-10 text-black mb-3 opacity-80"></i><span class="font-serif italic text-xl font-bold text-center px-4 truncate w-full">${f}</span><span class="text-xs text-gray-400 mt-2 uppercase tracking-wider">${c} Items</span>`;l.appendChild(b);});lucide.createIcons();}
        window.updateFolderDropdown=function(){const d=document.getElementById('folder-options');d.innerHTML='';Array.from(window.customFolders).forEach(f=>{const o=document.createElement('option');o.value=f;d.appendChild(o);});}
        window.openFolder=function(f){window.currentFolderContext=f;document.getElementById('view-folders').classList.add('hidden');document.getElementById('view-folder-detail').classList.remove('hidden');document.getElementById('sub-header').classList.remove('hidden');document.querySelector('#view-title').textContent=f;const i=window.allScraps.filter(s=>s.folder===f),g=document.getElementById('folder-detail-grid');g.innerHTML='';if(i.length===0)document.getElementById('folder-empty-state').classList.remove('hidden');else{document.getElementById('folder-empty-state').classList.add('hidden');i.forEach(itm=>g.appendChild(createCardElement(itm)));}lucide.createIcons();}
        window.openDetailView=function(s){if(isDetailEditing) toggleDetailEdit();window.currentScrap=s;document.getElementById('detail-title-input').textContent=s.title;document.getElementById('detail-image').src=s.imageUrl||'';document.getElementById('detail-summary-text').textContent=s.summary;document.getElementById('detail-full-text').innerText=s.content||"";document.getElementById('detail-memo-input').innerText=s.memo;document.getElementById('detail-type-badge').innerText = s.type || 'NOTE';document.getElementById('detail-view-modal').classList.remove('hidden');}
        window.closeDetailView=function(){document.getElementById('detail-view-modal').classList.add('hidden');}
        window.openSourceUrl=function(){if(!isDetailEditing && window.currentScrap&&window.currentScrap.sourceUrl)window.open(window.currentScrap.sourceUrl,'_blank');}
        window.toggleNewFavorite=function(){isNewItemFavorite=!isNewItemFavorite;const b=document.getElementById('new-favorite-btn');if(isNewItemFavorite){b.classList.remove('text-gray-400');b.classList.add('text-red-500');b.querySelector('svg').setAttribute('fill','currentColor');}else{b.classList.add('text-gray-400');b.classList.remove('text-red-500');b.querySelector('svg').removeAttribute('fill');}}
        window.openAddModal=function(){document.getElementById('add-modal').classList.remove('hidden');setTimeout(()=>document.getElementById('add-panel').classList.remove('translate-x-full'),10);updateFolderDropdown();isNewItemFavorite=false;const f=document.getElementById('new-favorite-btn');f.classList.add('text-gray-400');f.classList.remove('text-red-500');f.querySelector('svg').removeAttribute('fill');}
        window.closeAddModal=function(){document.getElementById('add-panel').classList.add('translate-x-full');setTimeout(()=>document.getElementById('add-modal').classList.add('hidden'),300);}
        window.resetForm=function(){document.querySelectorAll('#add-panel input, #add-panel textarea').forEach(i=>i.value='');}
        window.closeMenuModal=function(){document.getElementById('menu-modal').classList.add('hidden');}
        window.searchText="";window.handleSearchInput=function(e){window.searchText=e.target.value;renderScraps();}
        window.openCreateFolderModal=function(){folderModalMode='create';targetFolderOldName='';document.getElementById('folder-modal-title').textContent='New Folder';document.getElementById('folder-name-input').value='';showFolderModal();}
        window.openRenameModal=function(){if(!window.currentFolderContext)return;folderModalMode='rename';targetFolderOldName=window.currentFolderContext;document.getElementById('folder-modal-title').textContent='Rename Folder';document.getElementById('folder-name-input').value=window.currentFolderContext;showFolderModal();}
        function showFolderModal(){const m=document.getElementById('folder-input-modal'),c=document.getElementById('folder-modal-content');m.classList.remove('hidden');setTimeout(()=>{m.classList.remove('opacity-0');c.classList.remove('scale-95');document.getElementById('folder-name-input').focus();},10);}
        window.closeFolderModal=function(){const m=document.getElementById('folder-input-modal'),c=document.getElementById('folder-modal-content');m.classList.add('opacity-0');c.classList.add('scale-95');setTimeout(()=>{m.classList.add('hidden');},200);}
        window.handleFolderEnter=function(e){if(e.key==='Enter')submitFolderInput();}
        window.submitFolderInput=function(){const i=document.getElementById('folder-name-input'),n=i.value.trim();if(!n){i.focus();return;}if(folderModalMode==='create'){if(window.customFolders.has(n)){alert("Exists.");return;}window.customFolders.add(n);}else if(folderModalMode==='rename'){if(n===targetFolderOldName){closeFolderModal();return;}if(window.customFolders.has(n)){alert("Exists.");return;}window.customFolders.delete(targetFolderOldName);window.customFolders.add(n);window.allScraps.forEach(s=>{if(s.folder===targetFolderOldName)s.folder=n;});window.currentFolderContext=n;document.querySelector('#view-title').textContent=n;const items=window.allScraps.filter(s=>s.folder===n),g=document.getElementById('folder-detail-grid');g.innerHTML='';if(items.length===0)document.getElementById('folder-empty-state').classList.remove('hidden');else{document.getElementById('folder-empty-state').classList.add('hidden');items.forEach(i=>g.appendChild(createCardElement(i)));}lucide.createIcons();}renderFolders();updateFolderDropdown();saveData();closeFolderModal();}
    </script>
</body>
</html>
