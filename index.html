<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    
    <title>Archive v9.3 (Final UI Adjust)</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600&family=Playfair+Display:ital,wght@0,400;0,600;1,400;1,600&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/lucide@latest"></script>
    
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database-compat.js"></script>

    <style>
        body { font-family: 'Inter', sans-serif; overflow: hidden; margin: 0; background-color: #f9fafb; color: #18181b; }
        .font-serif { font-family: 'Playfair Display', serif; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        
        .folder-tab { padding: 14px 32px 12px; border-radius: 8px 8px 0 0; margin-right: -4px; font-family: 'Playfair Display', serif; font-style: italic; font-size: 15px; cursor: pointer; }
        .folder-tab.active { background: #ffffff; color: #000000; z-index: 20; font-weight: 700; box-shadow: 0 -4px 10px rgba(0,0,0,0.03); }
        .folder-tab.inactive { background: #27272a; color: #a1a1aa; z-index: 10; margin-top: 8px; font-weight: 400; }
        
        button:active { transform: scale(0.95); transition: 0.1s; }
        
        /* 카드 이미지 스타일 (수정됨: contain 적용 + 회색 배경) */
        .card-image-container {
            width: 100%;
            height: 100%;
            background-color: #e5e7eb; /* 요청하신 회색 배경 (Gray-200) */
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
        }
        .card-image {
            width: 100%;
            height: 100%;
            object-fit: contain; /* 이미지가 잘리지 않고 원본 비율 유지 */
            display: block;
        }

        #detail-image-container {
            background-color: #f8f9fa;
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
            border: 1px solid #e5e7eb;
            position: relative;
        }
        #detail-image {
            width: 100%;
            height: 100%;
            object-fit: contain; 
            display: block;
        }
    </style>
</head>
<body class="h-screen w-screen overflow-hidden">
    
    <input type="file" id="hidden-thumb-input" accept="image/*" class="hidden" onchange="handleThumbUpdate(event)">
    <input type="file" id="detail-thumb-input" accept="image/*" class="hidden" onchange="handleDetailThumbUpdate(event)">
    
    <div id="status-bar" class="hidden"></div>

    <div id="app-content" class="flex flex-col h-full relative z-10">
        <div class="pt-5 px-6 flex items-end justify-between select-none z-50 relative bg-[#f9fafb]">
            <div class="flex items-center">
                <div class="flex items-end pl-2">
                    <button onclick="switchTab('scraps')" id="tab-scraps" class="folder-tab active">Scraps</button>
                    <button onclick="switchTab('folders')" id="tab-folders" class="folder-tab inactive">Folders</button>
                    <button onclick="switchTab('favorites')" id="tab-favorites" class="folder-tab inactive">Favorites</button>
                </div>
            </div>
            <button onclick="openAddModal()" class="w-10 h-10 rounded-full bg-black text-white flex items-center justify-center shadow-lg hover:bg-gray-800 transition"><i data-lucide="plus" class="w-5 h-5"></i></button>
        </div>
        
        <div class="flex-grow relative overflow-hidden bg-white shadow-2xl z-10 flex flex-col rounded-t-lg border-t border-gray-100">
            <div class="px-8 py-5 flex items-center justify-between border-b border-gray-100 bg-white z-20">
                <div class="flex items-center">
                    <button id="folder-back-btn" onclick="closeFolderDetail()" class="mr-3 hidden p-2 hover:bg-gray-100 rounded-full"><i data-lucide="arrow-left" class="w-5 h-5 text-black"></i></button>
                    <div class="flex items-center gap-2">
                        <h2 id="view-title" class="font-serif italic text-xl text-black">All Scraps</h2>
                        <button id="rename-folder-btn" onclick="openRenameModal()" class="hidden p-1.5 text-gray-400 hover:text-black hover:bg-gray-100 rounded-full transition"><i data-lucide="pencil" class="w-3 h-3"></i></button>
                    </div>
                </div>
                <div class="relative">
                    <i data-lucide="search" class="absolute left-3 top-2.5 w-4 h-4 text-gray-400"></i>
                    <input type="text" id="main-search-input" oninput="handleSearchInput(event)" placeholder="Search..." class="pl-9 pr-4 py-2 bg-gray-50 border border-transparent rounded-sm text-sm focus:bg-white w-32 focus:w-48 transition-all outline-none">
                </div>
            </div>
            
            <div class="relative flex-grow overflow-hidden bg-[#fafafa]">
                <div id="view-grid" class="absolute inset-0 overflow-y-auto no-scrollbar p-6 pb-32">
                    <div id="scrap-grid" class="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-6 gap-4"></div>
                    <div id="empty-state" class="hidden h-full flex flex-col items-center justify-center text-gray-400 pb-20">
                        <i data-lucide="layers" class="w-8 h-8 mb-3 opacity-20 text-black"></i>
                        <p class="text-xs font-light tracking-widest uppercase">Empty Collection</p>
                    </div>
                </div>
                
                <div id="view-folders" class="absolute inset-0 overflow-y-auto no-scrollbar p-6 pb-32 hidden">
                    <div class="mb-6">
                        <button onclick="openCreateFolderModal()" class="flex items-center space-x-2 text-sm font-bold text-black border border-gray-300 rounded-sm px-6 py-3 bg-white hover:bg-gray-50 shadow-sm w-full md:w-auto justify-center">
                            <i data-lucide="folder-plus" class="w-4 h-4"></i>
                            <span>New Folder</span>
                        </button>
                    </div>
                    <div id="folder-list" class="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-6 gap-6"></div>
                </div>
                
                <div id="view-folder-detail" class="absolute inset-0 overflow-y-auto no-scrollbar p-6 pb-32 hidden bg-[#fafafa]">
                      <div id="folder-detail-grid" class="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-6 gap-4"></div>
                      <div id="folder-empty-state" class="hidden h-full flex flex-col items-center justify-center text-gray-400 pb-20"><p class="text-xs font-light tracking-widest uppercase">No items in this folder</p></div>
                </div>
            </div>
        </div>
    </div>

    <div id="add-modal" class="fixed inset-0 hidden z-[200]">
        <div class="absolute inset-0 bg-black/20 backdrop-blur-sm" onclick="closeAddModal()"></div>
        <div class="absolute inset-y-0 right-0 w-full md:w-[500px] bg-white shadow-2xl transform translate-x-full transition-transform duration-500 flex flex-col" id="add-panel">
            <div class="px-8 py-6 border-b border-gray-100 flex justify-between items-center bg-white z-10">
                <h2 class="font-serif italic text-2xl text-black">New Item</h2>
                <div class="flex items-center space-x-4">
                    <button type="button" id="new-favorite-btn" onclick="toggleNewFavorite()" class="text-gray-400 hover:text-red-500 transition"><i data-lucide="heart" class="w-5 h-5"></i></button>
                    <button onclick="resetForm()" class="p-2 hover:bg-gray-100 rounded-full transition"><i data-lucide="rotate-ccw" class="w-5 h-5"></i></button>
                    <button onclick="closeAddModal()" class="p-2 hover:bg-gray-100 rounded-full transition"><i data-lucide="x" class="w-5 h-5"></i></button>
                </div>
            </div>
            
            <div class="flex-grow overflow-y-auto p-8 space-y-6 custom-scrollbar">
                <div class="space-y-2 p-4 bg-gray-50 rounded-sm border border-gray-100">
                    <label class="block text-xs font-bold text-gray-400 uppercase tracking-wider">Media Source (URL)</label>
                    <div class="flex gap-2">
                        <input type="url" id="input-url" class="flex-1 bg-white border border-gray-200 rounded-sm px-4 py-2 text-sm" placeholder="Paste Link...">
                        <button type="button" onclick="handleMediaProcess()" class="bg-white border border-gray-200 text-black px-4 rounded-sm text-xs font-bold">Check</button>
                    </div>
                </div>
                
                <div class="space-y-2">
                    <label class="block text-[10px] font-bold text-gray-400 uppercase tracking-wider">Image</label>
                    <div class="flex gap-2">
                        <input type="text" id="input-image-url" class="flex-1 bg-gray-50 border-b border-gray-200 py-2 text-xs" placeholder="Auto-filled or Upload">
                        <button onclick="document.getElementById('hidden-thumb-input').click()" class="px-3 py-2 bg-gray-100 hover:bg-gray-200 rounded-sm text-gray-700 transition flex items-center gap-1 text-xs font-bold whitespace-nowrap" title="Upload Image">
                            <i data-lucide="image-plus" class="w-4 h-4"></i> Upload
                        </button>
                    </div>
                </div>

                <div class="space-y-2 relative">
                    <div class="flex justify-between items-center">
                        <label class="block text-[10px] font-bold text-blue-500 uppercase tracking-wider">Full Content</label>
                        <div class="flex gap-2">
                            <button onclick="resetApiKey()" class="flex items-center justify-center px-2 py-1 bg-gray-100 hover:bg-gray-200 rounded-sm text-xs text-gray-600 transition" title="Set API Key">
                                <i data-lucide="key" class="w-3 h-3 mr-1"></i>Key
                            </button>
                            <button onclick="handleAIAutoFill()" class="flex items-center space-x-1 px-3 py-1 bg-black text-white text-[10px] font-bold rounded-sm shadow hover:bg-gray-800 transition">
                                <i data-lucide="sparkles" class="w-3 h-3"></i><span>AI Auto-Fill</span>
                            </button>
                        </div>
                    </div>
                    <textarea id="input-content" rows="8" class="w-full bg-blue-50/20 border border-blue-100 rounded-sm p-4 text-sm leading-relaxed" placeholder="Paste text to auto-generate..."></textarea>
                </div>

                <div class="border-t border-gray-100 pt-6 space-y-6">
                    <div class="space-y-1">
                        <label class="text-[10px] font-bold text-gray-400 uppercase tracking-wider">Title</label>
                        <input type="text" id="input-title" class="w-full text-lg font-serif border-b border-gray-200 py-2 bg-transparent" placeholder="Entry Title">
                    </div>
                    
                    <div class="grid grid-cols-2 gap-4">
                        <div class="space-y-1">
                            <label class="text-[10px] font-bold text-gray-400 uppercase tracking-wider">Type</label>
                            <select id="input-type-select" class="w-full bg-transparent border-b border-gray-200 py-2 text-sm"><option value="news">Article</option><option value="video">Video</option><option value="image">Image</option><option value="paper">Paper</option><option value="custom">Other</option></select>
                        </div>
                        <div class="space-y-1">
                            <label class="text-[10px] font-bold text-gray-400 uppercase tracking-wider">Folder</label>
                            <input type="text" id="input-folder" list="folder-options" class="w-full bg-transparent border-b border-gray-200 py-2 text-sm" placeholder="Select/Type">
                            <datalist id="folder-options"></datalist>
                        </div>
                    </div>
                    
                    <div class="space-y-1">
                        <label class="text-[10px] font-bold text-gray-400 uppercase tracking-wider">Summary</label>
                        <textarea id="input-summary" rows="3" class="w-full bg-gray-50 rounded-sm p-4 text-sm"></textarea>
                    </div>
                    <div class="space-y-1">
                        <label class="text-[10px] font-bold text-gray-400 uppercase tracking-wider">Memo</label>
                        <textarea id="input-memo" rows="2" class="w-full bg-yellow-50/50 rounded-sm p-4 text-sm"></textarea>
                    </div>
                </div>
            </div>
            
            <div class="p-6 border-t border-gray-50 bg-white">
                <button type="button" onclick="handleSaveScrap()" id="save-button" class="w-full bg-black text-white py-4 rounded-sm font-medium text-sm shadow-xl hover:bg-gray-800 transition">Save</button>
            </div>
        </div>
    </div>

    <div id="detail-view-modal" class="fixed inset-0 z-[300] hidden bg-white flex flex-col">
        <div class="px-6 py-4 border-b border-gray-100 flex items-center justify-between bg-white z-10 shrink-0">
            <button onclick="closeDetailView()" class="p-2 hover:bg-gray-50 rounded-full transition"><i data-lucide="arrow-left" class="w-6 h-6"></i></button>
            <span class="font-serif italic text-gray-500 text-sm">DETAIL</span>
            <div class="w-10"></div>
        </div>

        <div class="flex-grow overflow-y-auto p-6 md:p-12 pb-20 custom-scrollbar">
            <div class="max-w-6xl mx-auto">
                <div class="grid grid-cols-1 md:grid-cols-3 gap-8 md:gap-12">
                    
                    <div class="col-span-1">
                        <div id="detail-image-container" class="aspect-[3/4] w-full rounded-sm relative bg-gray-100">
                            <img id="detail-image" class="transition duration-300">
                            
                            <button onclick="openSourceUrl()" class="absolute top-3 left-3 bg-white/90 text-black text-xs font-bold px-3 py-1.5 rounded-full shadow-lg flex items-center gap-1 hover:bg-white z-20">
                                <i data-lucide="external-link" class="w-3 h-3"></i> Link
                            </button>

                            <button onclick="triggerDetailThumbUpload()" class="absolute bottom-3 right-3 bg-black/70 text-white p-2.5 rounded-full shadow-xl flex items-center justify-center hover:bg-black transition z-20 backdrop-blur-sm" title="Change Image">
                                <i data-lucide="camera" class="w-5 h-5"></i>
                            </button>
                        </div>
                    </div>

                    <div class="col-span-1 md:col-span-2 flex flex-col gap-8">
                        <div>
                            <h1 id="detail-title-input" class="text-3xl font-serif italic text-black leading-tight mb-6"></h1>
                            
                            <div class="bg-gray-50 p-6 rounded-sm border-l-4 border-black mb-8">
                                <label class="text-[10px] font-bold text-gray-400 uppercase tracking-wider block mb-2">Key Summary</label>
                                <p id="detail-summary-text" class="text-sm text-gray-800 leading-relaxed font-medium"></p>
                            </div>

                            <div>
                                <label class="text-[10px] font-bold text-gray-400 uppercase tracking-wider block mb-3 border-b border-gray-100 pb-1">Full Content</label>
                                <div id="detail-full-text" class="text-sm text-gray-600 leading-relaxed whitespace-pre-line text-justify min-h-[50px]"></div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="mt-12 pt-8 border-t border-gray-100">
                    <label class="text-[10px] font-bold text-gray-400 uppercase tracking-wider block mb-3">Memo</label>
                    <div class="bg-yellow-50/50 p-6 rounded-sm border border-yellow-200/50 min-h-[100px]">
                        <p id="detail-memo-input" class="font-serif italic text-gray-800 text-sm whitespace-pre-wrap"></p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="menu-modal" class="fixed inset-0 hidden z-[400]">
        <div class="absolute inset-0 bg-black/20" onclick="closeMenuModal()"></div>
        <div class="absolute bottom-0 w-full bg-white p-6 rounded-t-lg shadow-2xl transition-transform" id="menu-panel">
            <button onclick="menuAction('delete')" class="w-full py-4 text-red-500 font-bold mb-2 bg-red-50 rounded">DELETE</button>
            <button onclick="closeMenuModal()" class="w-full py-4 text-black font-bold">CANCEL</button>
        </div>
    </div>

    <div id="folder-input-modal" class="fixed inset-0 z-[500] hidden flex items-center justify-center transition-opacity duration-200 opacity-0">
        <div class="absolute inset-0 bg-black/20 backdrop-blur-sm" onclick="closeFolderModal()"></div>
        <div class="bg-white p-8 rounded-sm shadow-2xl w-[90%] max-w-sm relative z-10 border border-gray-100 transform transition-all duration-200 scale-95" id="folder-modal-content">
            <h3 id="folder-modal-title" class="font-serif italic text-2xl mb-6 text-center text-black">New Folder</h3>
            <div class="space-y-4">
                <input type="text" id="folder-name-input" class="w-full border-b-2 border-gray-200 py-3 text-lg font-medium text-center focus:outline-none focus:border-black transition-colors bg-transparent placeholder-gray-300" placeholder="Type name..." onkeypress="handleFolderEnter(event)">
                <div class="flex gap-2 pt-4">
                    <button onclick="closeFolderModal()" class="flex-1 py-3 text-xs font-bold text-gray-400 hover:bg-gray-50 rounded-sm transition">CANCEL</button>
                    <button onclick="submitFolderInput()" class="flex-1 bg-black text-white py-3 rounded-sm text-xs font-bold hover:bg-gray-800 shadow-lg transition transform active:scale-95">SAVE</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // --- FIREBASE CONFIG ---
        const firebaseConfig = {
          apiKey: "AIzaSyBqbdAQoIbzGQnD3w35xYkjXWzjc1c8zDs",
          authDomain: "scrap-2e367.firebaseapp.com",
          databaseURL: "https://scrap-2e367-default-rtdb.firebaseio.com",
          projectId: "scrap-2e367",
          storageBucket: "scrap-2e367.firebasestorage.app",
          messagingSenderId: "930951535494",
          appId: "1:930951535494:web:a59f16f12576338bb5aa07",
          measurementId: "G-4HM5SEHP15"
        };

        let db = null;
        try {
            firebase.initializeApp(firebaseConfig);
            db = firebase.database();
        } catch (e) { console.error(e); }

        window.allScraps = []; 
        window.customFolders = new Set(['General', 'Design']); 
        window.currentTab = 'scraps'; 
        window.currentScrap = null;
        window.currentFolderContext = null; 
        window.searchText = "";
        
        let folderModalMode = 'create'; 
        let targetFolderOldName = '';
        let isNewItemFavorite = false;

        window.onload = function() { loadData(); lucide.createIcons(); };

        // --- API Key & Image Logic ---
        
        function getGeminiKey() {
            let key = localStorage.getItem('GEMINI_API_KEY');
            if (!key) {
                key = prompt("Gemini API Key를 입력해주세요. (브라우저에 저장됩니다)");
                if (key && key.trim() !== "") {
                    localStorage.setItem('GEMINI_API_KEY', key.trim());
                } else {
                    return null;
                }
            }
            return key;
        }

        window.resetApiKey = function() {
            const newKey = prompt("새로운 API Key를 입력하세요:");
            if(newKey) {
                localStorage.setItem('GEMINI_API_KEY', newKey.trim());
                alert("Key updated.");
            }
        }

        window.handleAIAutoFill = async function() {
            const content = document.getElementById('input-content').value;
            if (!content || content.length < 5) {
                alert("내용(Content)을 먼저 입력해주세요.");
                return;
            }
            
            const apiKey = getGeminiKey();
            if (!apiKey) return;

            const btn = document.querySelector('button[onclick="handleAIAutoFill()"]');
            const originalText = btn.innerHTML;
            btn.innerHTML = `<i data-lucide="loader-2" class="w-3 h-3 animate-spin"></i> Analyzing...`;
            lucide.createIcons();

            const prompt = `
                Analyze the following text. 
                Return ONLY a JSON object with these keys: "title", "summary" (3 sentences), "folder" (1 word category), "type" (one of: news, paper, custom, video).
                Do not include markdown.
                Text: "${content.substring(0, 3000)}"
            `;

            try {
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${apiKey}`, {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ 
                        contents: [{ parts: [{ text: prompt }] }]
                    })
                });

                const data = await response.json();
                
                if (data.error) throw new Error("API Error: " + data.error.message);
                if (!data.candidates || data.candidates.length === 0) throw new Error("AI No Response");

                let textResult = data.candidates[0].content.parts[0].text;
                textResult = textResult.replace(/```json/g, '').replace(/```/g, '').trim();
                
                let parsed;
                try { parsed = JSON.parse(textResult); } catch(e) { throw new Error("AI parsing failed"); }

                if(parsed.title) document.getElementById('input-title').value = parsed.title;
                if(parsed.summary) document.getElementById('input-summary').value = parsed.summary;
                if(parsed.folder) document.getElementById('input-folder').value = parsed.folder;
                if(parsed.type) document.getElementById('input-type-select').value = parsed.type;

            } catch (error) {
                console.error("AI Error:", error);
                alert("분석 실패: " + error.message);
            } finally {
                btn.innerHTML = originalText;
                lucide.createIcons();
            }
        }

        window.handleThumbUpdate = function(event) {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    document.getElementById('input-image-url').value = e.target.result;
                };
                reader.readAsDataURL(file);
            }
        };

        // --- Data Sync ---
        function loadData() {
            if (!db) return;
            db.ref('scraps').on('value', (snapshot) => {
                const data = snapshot.val();
                window.allScraps = data ? data : [];
                renderScraps(); 
                if(window.currentFolderContext && !document.getElementById('view-folder-detail').classList.contains('hidden')) {
                     openFolder(window.currentFolderContext);
                }
            });
            db.ref('folders').on('value', (snapshot) => {
                const data = snapshot.val();
                if(data) window.customFolders = new Set(data);
                renderFolders(); updateFolderDropdown();
            });
        }
        function saveData() {
            if (!db) return;
            try {
                db.ref('scraps').set(window.allScraps);
                db.ref('folders').set(Array.from(window.customFolders));
            } catch(e) { console.log(e); }
        }

        // --- View & Render Logic ---
        window.switchTab = function(tabName) {
            window.currentTab = tabName;
            document.querySelectorAll('.folder-tab').forEach(el => {
                if(el.id === `tab-${tabName}`) { el.classList.add('active'); el.classList.remove('inactive'); }
                else { el.classList.add('inactive'); el.classList.remove('active'); }
            });
            
            if (tabName === 'folders') {
                document.getElementById('view-grid').classList.add('hidden');
                document.getElementById('view-folders').classList.remove('hidden');
                renderFolders(); 
            } else {
                document.getElementById('view-grid').classList.remove('hidden');
                document.getElementById('view-folders').classList.add('hidden');
                renderScraps();
            }
            document.getElementById('view-folder-detail').classList.add('hidden');
            document.getElementById('folder-back-btn').classList.add('hidden');
            document.getElementById('rename-folder-btn').classList.add('hidden');
        }

        window.handleSearchInput = function(e) {
            window.searchText = e.target.value.toLowerCase().trim();
            renderScraps();
        }

        window.renderScraps = function() {
            const grid = document.getElementById('scrap-grid');
            grid.innerHTML = '';
            
            let filtered = window.allScraps;

            if (window.searchText && window.searchText.length > 0) {
                filtered = filtered.filter(s => s.title && s.title.toLowerCase().includes(window.searchText));
            }

            if (window.currentTab === 'favorites') {
                filtered = filtered.filter(s => s.isFavorite === true);
            }

            filtered.forEach(item => grid.appendChild(createCardElement(item)));
            lucide.createIcons();
            
            if(filtered.length === 0) document.getElementById('empty-state').classList.remove('hidden');
            else document.getElementById('empty-state').classList.add('hidden');
        }

        window.renderFolders = function() {
            const list = document.getElementById('folder-list');
            list.innerHTML = '';
            Array.from(window.customFolders).sort().forEach(f => {
                const count = window.allScraps.filter(s => s.folder === f).length;
                const btn = document.createElement('div');
                btn.className = "aspect-square bg-gray-50 border border-gray-200 rounded-sm flex flex-col items-center justify-center cursor-pointer active:bg-gray-200 hover:bg-gray-100 transition";
                btn.onclick = () => openFolder(f);
                btn.innerHTML = `<i data-lucide="folder" class="w-8 h-8 text-black mb-2 opacity-80"></i><span class="font-serif italic text-lg font-bold text-center px-2 truncate w-full">${f}</span><span class="text-xs text-gray-400 mt-1">${count} items</span>`;
                list.appendChild(btn);
            });
            lucide.createIcons();
        }
        
        // --- Grid Card (수정됨: 텍스트 크기 증가 + 이미지 contain) ---
        function createCardElement(item) {
            const card = document.createElement('div');
            card.className = "relative group cursor-pointer w-full aspect-[3/4] bg-white rounded-sm shadow-sm border border-gray-200 overflow-hidden";
            
            let media = `<div class="card-image-container"><i data-lucide="image" class="w-8 h-8 text-gray-300"></i></div>`;
            
            if (item.imageUrl) {
                // 수정: card-image-container 배경색 회색, card-image object-contain
                media = `<div class="card-image-container"><img src="${item.imageUrl}" class="card-image" onerror="this.parentElement.innerHTML='<i data-lucide=image-off class=\'w-8 h-8 text-gray-300\'></i>'"></div>`;
            }

            // 수정: text-xs -> text-sm, font-bold 유지
            card.innerHTML = `
                <div class="h-[65%] w-full overflow-hidden relative">${media}</div>
                <div class="h-[35%] p-4 flex flex-col justify-between bg-white">
                    <h3 class="font-serif text-sm font-bold text-black leading-tight line-clamp-2">${item.title}</h3>
                    <div class="flex justify-between items-center">
                        <span class="text-[10px] text-gray-400 uppercase truncate max-w-[80px]">${item.folder}</span>
                        ${item.isFavorite ? '<i data-lucide="heart" class="w-3 h-3 text-red-500 fill-current"></i>' : ''}
                    </div>
                </div>
            `;
            
            card.onclick = () => openDetailView(item);
            
            let timer;
            card.addEventListener('touchstart', () => { timer = setTimeout(() => { window.currentScrap = item; document.getElementById('menu-modal').classList.remove('hidden'); }, 600); });
            card.addEventListener('touchend', () => clearTimeout(timer));
            card.addEventListener('contextmenu', (e) => { e.preventDefault(); window.currentScrap = item; document.getElementById('menu-modal').classList.remove('hidden'); });
            
            return card;
        }

        // --- Detail View & Edit ---
        window.openDetailView = function(scrap) {
            window.currentScrap = scrap;
            document.getElementById('detail-title-input').textContent = scrap.title;
            
            const imgEl = document.getElementById('detail-image');
            if(scrap.imageUrl) {
                imgEl.src = scrap.imageUrl;
                imgEl.classList.remove('hidden');
                imgEl.onerror = function() { this.style.display = 'none'; }
            } else {
                imgEl.src = '';
                imgEl.classList.add('hidden');
            }

            document.getElementById('detail-summary-text').textContent = scrap.summary;
            document.getElementById('detail-full-text').innerText = scrap.content || ""; 
            document.getElementById('detail-memo-input').innerText = scrap.memo;
            document.getElementById('detail-view-modal').classList.remove('hidden');
        }

        window.triggerDetailThumbUpload = function() {
            document.getElementById('detail-thumb-input').click();
        }

        window.handleDetailThumbUpdate = function(event) {
            const file = event.target.files[0];
            if (file && window.currentScrap) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    const newUrl = e.target.result;
                    const imgEl = document.getElementById('detail-image');
                    imgEl.src = newUrl;
                    imgEl.classList.remove('hidden');
                    
                    window.currentScrap.imageUrl = newUrl;
                    
                    const index = window.allScraps.findIndex(s => s.id === window.currentScrap.id);
                    if(index !== -1) {
                        window.allScraps[index] = window.currentScrap;
                        saveData();
                        renderScraps();
                    }
                };
                reader.readAsDataURL(file);
            }
        }

        window.closeDetailView = function() { document.getElementById('detail-view-modal').classList.add('hidden'); }
        window.openSourceUrl = function() {
            if(window.currentScrap && window.currentScrap.sourceUrl) {
                window.open(window.currentScrap.sourceUrl, '_blank');
            }
        }
        
        // --- Add/Save/Delete Logic ---
        window.handleSaveScrap = function() {
            const btn = document.getElementById('save-button');
            const title = document.getElementById('input-title').value;
            if(!title) { alert("Title is required"); return; }
            
            btn.textContent = 'Saving...';
            const folderInput = document.getElementById('input-folder').value || 'General';
            if(!window.customFolders.has(folderInput)) { window.customFolders.add(folderInput); renderFolders(); }

            const newItem = {
                id: Date.now().toString(),
                title: title,
                summary: document.getElementById('input-summary').value,
                content: document.getElementById('input-content').value,
                sourceUrl: document.getElementById('input-url').value,
                imageUrl: document.getElementById('input-image-url').value,
                type: document.getElementById('input-type-select').value,
                folder: folderInput,
                memo: document.getElementById('input-memo').value,
                isFavorite: isNewItemFavorite,
                createdAt: new Date().toISOString()
            };
            
            window.allScraps.unshift(newItem);
            saveData();
            
            closeAddModal(); window.resetForm();
            switchTab('scraps');
            btn.textContent = 'Save';
        }

        window.openAddModal = function() { 
            document.getElementById('add-modal').classList.remove('hidden'); 
            setTimeout(() => document.getElementById('add-panel').classList.remove('translate-x-full'), 10); 
            updateFolderDropdown(); 
            isNewItemFavorite = false; 
            const favBtn = document.getElementById('new-favorite-btn');
            favBtn.classList.add('text-gray-400'); favBtn.classList.remove('text-red-500'); favBtn.querySelector('svg').removeAttribute('fill');
        }
        window.closeAddModal = function() { document.getElementById('add-panel').classList.add('translate-x-full'); setTimeout(() => document.getElementById('add-modal').classList.add('hidden'), 300); }
        window.resetForm = function() { document.querySelectorAll('#add-panel input, #add-panel textarea').forEach(i => i.value = ''); }
        
        window.closeMenuModal = function() { document.getElementById('menu-modal').classList.add('hidden'); }
        window.menuAction = function(action) {
            if(action === 'delete') {
                if(confirm("Delete this item?")) {
                    window.allScraps = window.allScraps.filter(s => s.id !== window.currentScrap.id);
                    saveData(); closeMenuModal();
                    if(window.currentFolderContext && !document.getElementById('view-folder-detail').classList.contains('hidden')) { openFolder(window.currentFolderContext); } 
                    else { renderScraps(); }
                }
            }
        }
        
        // --- Folder Logic ---
        window.openCreateFolderModal = function() {
            folderModalMode = 'create'; targetFolderOldName = '';
            document.getElementById('folder-modal-title').textContent = 'New Folder';
            document.getElementById('folder-name-input').value = '';
            showFolderModal();
        }
        window.openRenameModal = function() {
            if(!window.currentFolderContext) return;
            folderModalMode = 'rename'; targetFolderOldName = window.currentFolderContext;
            document.getElementById('folder-modal-title').textContent = 'Rename Folder';
            document.getElementById('folder-name-input').value = window.currentFolderContext;
            showFolderModal();
        }
        function showFolderModal() {
            const modal = document.getElementById('folder-input-modal');
            const content = document.getElementById('folder-modal-content');
            modal.classList.remove('hidden');
            setTimeout(() => { modal.classList.remove('opacity-0'); content.classList.remove('scale-95'); document.getElementById('folder-name-input').focus(); }, 10);
        }
        window.closeFolderModal = function() {
            const modal = document.getElementById('folder-input-modal');
            const content = document.getElementById('folder-modal-content');
            modal.classList.add('opacity-0'); content.classList.add('scale-95');
            setTimeout(() => { modal.classList.add('hidden'); }, 200);
        }
        window.handleFolderEnter = function(e) { if (e.key === 'Enter') submitFolderInput(); }
        window.submitFolderInput = function() {
            const input = document.getElementById('folder-name-input');
            const name = input.value.trim();
            if (!name) { input.focus(); return; }

            if (folderModalMode === 'create') {
                if(window.customFolders.has(name)) { alert("Exists."); return; }
                window.customFolders.add(name);
            } else if (folderModalMode === 'rename') {
                if (name === targetFolderOldName) { closeFolderModal(); return; }
                if (window.customFolders.has(name)) { alert("Exists."); return; }
                window.customFolders.delete(targetFolderOldName);
                window.customFolders.add(name);
                window.allScraps.forEach(scrap => { if (scrap.folder === targetFolderOldName) scrap.folder = name; });
                window.currentFolderContext = name;
                document.querySelector('#view-title').textContent = name;
                // Refresh Detail View
                const items = window.allScraps.filter(s => s.folder === name);
                const grid = document.getElementById('folder-detail-grid');
                grid.innerHTML = '';
                if(items.length === 0) document.getElementById('folder-empty-state').classList.remove('hidden');
                else { document.getElementById('folder-empty-state').classList.add('hidden'); items.forEach(item => grid.appendChild(createCardElement(item))); }
                lucide.createIcons();
            }
            renderFolders(); updateFolderDropdown(); saveData(); closeFolderModal();
        }
        window.updateFolderDropdown = function() {
            const dl = document.getElementById('folder-options'); dl.innerHTML = '';
            Array.from(window.customFolders).forEach(f => { const op = document.createElement('option'); op.value = f; dl.appendChild(op); });
        }
        window.openFolder = function(folderName) {
            window.currentFolderContext = folderName;
            document.getElementById('view-folders').classList.add('hidden');
            document.getElementById('view-folder-detail').classList.remove('hidden');
            document.getElementById('folder-back-btn').classList.remove('hidden');
            document.getElementById('rename-folder-btn').classList.remove('hidden');
            document.querySelector('#view-title').textContent = folderName;
            
            const items = window.allScraps.filter(s => s.folder === folderName);
            const grid = document.getElementById('folder-detail-grid');
            grid.innerHTML = '';
            if(items.length === 0) document.getElementById('folder-empty-state').classList.remove('hidden');
            else { document.getElementById('folder-empty-state').classList.add('hidden'); items.forEach(item => grid.appendChild(createCardElement(item))); }
            lucide.createIcons();
        }
        
        window.toggleNewFavorite = function() {
            isNewItemFavorite = !isNewItemFavorite;
            const btn = document.getElementById('new-favorite-btn');
            if(isNewItemFavorite) { btn.classList.remove('text-gray-400'); btn.classList.add('text-red-500'); btn.querySelector('svg').setAttribute('fill', 'currentColor'); }
            else { btn.classList.add('text-gray-400'); btn.classList.remove('text-red-500'); btn.querySelector('svg').removeAttribute('fill'); }
        }

        window.handleMediaProcess = function() {
             const url = document.getElementById('input-url').value;
             if(url.includes('youtu')) {
                 const id = url.split('v=')[1] || url.split('/').pop();
                 const thumb = `https://img.youtube.com/vi/${id.split('&')[0]}/mqdefault.jpg`;
                 document.getElementById('input-image-url').value = thumb;
                 document.getElementById('input-type-select').value = 'video';
             }
        }
    </script>
</body>
</html>
